{
  "connectors": ["AWS"],
  "title": "Find all Backup plans with retention under 35 days",
  "query": "with all_plans as (\n  select\n    arn,\n    r as Rules,\n    title,\n    region,\n    account_id\n  from\n    aws_backup_plan,\n    jsonb_array_elements(backup_plan -\u003e 'Rules') as r\n)\nselect\n  -- Required Columns\n  -- The resource ARN can be duplicate as we are checking all the associated rules to the backup-plan\n  -- Backup plans are composed of one or more backup rules.\n  -- https://docs.aws.amazon.com/aws-backup/latest/devguide/creating-a-backup-plan.html\n  r.arn as resource,\n  case\n    when r.Rules is null then 'alarm'\n    when r.Rules -\u003e\u003e 'Lifecycle' is null then 'ok'\n    when (r.Rules -\u003e 'Lifecycle' -\u003e\u003e 'DeleteAfterDays')::int \u003e= 37 then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when r.Rules is null then r.title || ' retention period not set.'\n    when r.Rules -\u003e\u003e 'Lifecycle' is null then (r.Rules -\u003e\u003e 'RuleName') || ' retention period set to never expire.'\n    else (r.Rules -\u003e\u003e 'RuleName') || ' retention period set to ' || (r.Rules -\u003e 'Lifecycle' -\u003e\u003e 'DeleteAfterDays') || ' days.'\n  end as reason,\n  -- Additional Dimensions\n  r.region,\n  r.account_id\nfrom\n  all_plans as r"
}