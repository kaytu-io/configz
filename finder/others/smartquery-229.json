{
  "connectors": ["AWS"],
  "title": "Find all Security groups should only allow unrestricted incoming traffic for authorized ports (80, 443)",
  "query": "with ingress_unauthorized_ports as (\n  select\n    group_id,\n    count(*)\n  from\n    aws_vpc_security_group_rule\n  where\n    type = 'ingress'\n    and cidr_ip = '0.0.0.0/0'\n    and (from_port is null or from_port not in (80,443))\n  group by group_id\n)\nselect\n  -- Required Columns\n  sg.arn as resource,\n  case\n    when ingress_unauthorized_ports.count \u003e 0 then 'alarm'\n    else 'ok'\n  end as status,\n  case\n    when ingress_unauthorized_ports.count \u003e 0 then sg.title || ' having unrestricted incoming traffic other than default ports from 0.0.0.0/0 '\n    else sg.title || ' allows unrestricted incoming traffic for authorized default ports (80,443).'\n  end as reason,\n  sg.region,\n  sg.account_id\nfrom\n  aws_vpc_security_group as sg\n  left join ingress_unauthorized_ports on ingress_unauthorized_ports.group_id = sg.group_id"
}