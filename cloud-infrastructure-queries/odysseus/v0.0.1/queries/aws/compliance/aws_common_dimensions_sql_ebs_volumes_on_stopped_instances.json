{
  "ID": "aws_common_dimensions_sql_ebs_volumes_on_stopped_instances",
  "Engine": "odysseus-v0.0.1",
  "QueryToExecute": "  with vols_and_instances as (\n    select\n      v.arn,\n      v._ctx,\n      v.volume_id,\n      i.instance_id,\n      v.region,\n      v.account_id,\n      sum(\n        case\n          when i.instance_state = 'stopped' then 0\n          else 1\n        end\n      ) as running_instances\n    from\n      aws_ebs_volume as v\n      left join jsonb_array_elements(v.attachments) as va on true\n      left join aws_ec2_instance as i on va -\u003e\u003e 'InstanceId' = i.instance_id\n    group by\n      v.arn,\n      v._ctx,\n      v.volume_id,\n      i.instance_id,\n      i.instance_id,\n      v.region,\n      v.account_id\n)\nselect\n  arn as resource,\n  case\n    when running_instances \u003e 0 then 'ok'\n    else 'alarm'\n  end as status,\n  volume_id || ' is attached to ' || running_instances || ' running instances.' as reason\n  , region, account_id\nfrom\n  vols_and_instances;\n",
  "Connector": "AWS",
  "PrimaryTable": "aws_ebs_volume",
  "ListOfTables": [
    "aws_ebs_volume",
    "aws_ec2_instance"
  ]
}