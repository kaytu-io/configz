{
  "ID": "aws_tag_dimensions_sql.common_dimensions_sql_eks_node_group_with_graviton",
  "Engine": "odysseus-v0.0.1",
  "QueryToExecute": "  with node_group_using_launch_template_image_id as (\n    select\n      g.arn as node_group_arn,\n      v.image_id as image_id\n    from\n      aws_eks_node_group as g\n      left join aws_ec2_launch_template_version as v on v.launch_template_id = g.launch_template -\u003e\u003e 'Id' and v.version_number = (g.launch_template -\u003e\u003e 'Version')::int\n    where\n      g.launch_template is not null\n  ), ami_architecture as (\n    select\n      node_group_arn,\n      architecture,\n      case when s.platform_details = 'Linux/UNIX' then 'linux' else platform_details end as platform\n    from\n      node_group_using_launch_template_image_id as i\n      left join aws_ec2_ami_shared as s on s.image_id = i.image_id\n    where\n      architecture is not null\n    union\n    select\n      node_group_arn,\n      architecture,\n      case when a.platform_details = 'Linux/UNIX' then 'linux' else platform_details end as platform\n    from\n      node_group_using_launch_template_image_id as i\n      left join aws_ec2_ami as a on a.image_id = i.image_id\n    where\n      architecture is not null\n)\nselect\n  arn as resource,\n  case\n    when ami_type = 'CUSTOM%' and a.platform \u003c\u003e 'linux' then 'skip'\n    when ami_type = 'CUSTOM%' and a.architecture = 'arm_64' and a.platform = 'linux' then 'ok'\n    when ami_type = 'CUSTOM%' and a.architecture \u003c\u003e 'arm_64' and a.platform = 'linux' then 'alarm'\n    when ami_type not like 'AL2_%' then 'skip'\n    when ami_type = 'AL2_ARM_64' then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when ami_type = 'CUSTOM%' and a.platform \u003c\u003e 'linux' then title || ' is not using linux platform.'\n    when ami_type = 'CUSTOM%' and a.architecture = 'x86_64' and a.platform = 'linux' then title || ' is using Graviton2 processor.'\n    when ami_type = 'CUSTOM%' and a.architecture \u003c\u003e 'arm_64' and a.platform = 'linux' then title || ' is not using Graviton2 processor.'\n    when ami_type not like 'AL2_%' then title || ' is not using linux platform.'\n    when ami_type = 'AL2_ARM_64' then title || ' is using Graviton2 processor.'\n    else title || ' is not using Graviton2 processor.'\n  end as reason\n  \n  , region, account_id\nfrom\n  aws_eks_node_group as g\n  left join ami_architecture as a on a.node_group_arn = g.arn;\n",
  "Connector": "AWS",
  "PrimaryTable": "aws_eks_node_group",
  "ListOfTables": [
    "aws_ec2_ami",
    "aws_ec2_ami_shared",
    "aws_ec2_launch_template_version",
    "aws_eks_node_group"
  ]
}