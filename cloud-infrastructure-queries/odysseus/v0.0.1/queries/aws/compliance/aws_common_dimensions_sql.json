{
  "ID": "aws_common_dimensions_sql",
  "Engine": "odysseus-v0.0.1",
  "QueryToExecute": "with ram_shared_resources as (\n  select distinct\n    rsa.associated_entity as \"shared_resource\",\n    rpa.associated_entity as \"shared_with_organization_unit\",\n    rsa.status,\n    rsa.region,\n    rsa.account_id,\n    rsa._ctx,\n    split_part((rpa.associated_entity), '/', 1)\n  from\n    aws_ram_resource_association as rsa\n    inner join aws_ram_principal_association as rpa on rsa.resource_share_name = rpa.resource_share_name\n  where\n    rsa.status \u003c\u003e 'FAILED' and rpa.status \u003c\u003e 'FAILED'\n    and split_part((rpa.associated_entity), '/', 1) like '%:ou'\n),\nshared_data as (\n  select\n    (regexp_split_to_array(shared_resource, ':'))[6] as resource,\n    to_jsonb(string_to_array(string_agg(split_part(shared_with_organization_unit, '/', 3), ','), ',', '')) - ($1)::text[] as untrusted_organizations_unit,\n    region,\n    _ctx,\n    account_id\n  FROM\n    ram_shared_resources\n  group by\n    shared_resource,\n    region,\n    _ctx,\n    account_id\n)\nselect\n  resource,\n  case\n    when jsonb_array_length(untrusted_organizations_unit) \u003e 0 then 'alarm'\n    else 'ok'\n  end as status,\n  case\n    when jsonb_array_length(untrusted_organizations_unit) \u003e 0 then\n      resource ||\n      case\n        when jsonb_array_length(untrusted_organizations_unit) \u003e 2 then\n          concat( ' shared with untrusted OUs ' ,untrusted_organizations_unit #\u003e\u003e '{0}', ', ', untrusted_organizations_unit #\u003e\u003e '{1}', ' and ', (jsonb_array_length(untrusted_organizations_unit) - 2)::text, ' more.')\n        when jsonb_array_length(untrusted_organizations_unit) = 2 then concat(' shared with untrusted OUs ', untrusted_organizations_unit #\u003e\u003e '{0}', ', ', untrusted_organizations_unit #\u003e\u003e '{1}', '.')\n        else concat(' shared with untrusted OU ', untrusted_organizations_unit #\u003e\u003e '{0}', '.')\n      end\n    else resource || ' shared with trusted OU(s).'\n  end as reason\n  , region, account_id\nfrom\n  shared_data;\n",
  "Connector": "AWS",
  "PrimaryTable": "aws_ram_resource_association",
  "ListOfTables": [
    "aws_ram_principal_association",
    "aws_ram_resource_association"
  ]
}