{
  "ID": "azure_appservice_web_app_register_with_active_directory_enabled",
  "Title": "Ensure that Register with Azure Active Directory is enabled on App Service",
  "Description": "Managed service identity in App Service makes the app more secure by eliminating secrets from the app, such as credentials in the connection strings. When registering with Azure Active Directory in the app service, the app will connect to other Azure services securely without the need of username and passwords.",
  "Query": {
    "Connector": "Azure",
    "Engine": "odysseus-v0.0.1",
    "ListOfTables": [
      "azure_app_service_web_app",
      "azure_subscription"
    ],
    "PrimaryTable": "azure_app_service_web_app",
    "QueryToExecute": "select\n  app.id as resource,\n  app.kaytu_account_id as kaytu_account_id,\n  app.kaytu_resource_id as kaytu_resource_id,\n  case\n    when identity = '{}' then 'alarm'\n    else 'ok'\n  end as status,\n  case\n    when identity = '{}' then name || ' register with azure active directory disabled.'\n    else name || ' register with azure active directory enabled.'\n  end as reason\n  \n  , app.resource_group as resource_group\n  , sub.display_name as subscription\nfrom\n  azure_app_service_web_app as app,\n  azure_subscription as sub\nwhere\n  sub.subscription_id = app.subscription_id;\n"
  },
  "DocumentURI": "",
  "ManualVerification": false,
  "Severity": "medium",
  "Tags": {
    "category": [
      "Compliance"
    ],
    "cis": [
      "true"
    ],
    "cis_item_id": [
      "9.5"
    ],
    "cis_level": [
      "1"
    ],
    "cis_section_id": [
      "9"
    ],
    "cis_type": [
      "automated"
    ],
    "cis_version": [
      "v1.3.0"
    ],
    "plugin": [
      "azure"
    ],
    "service": [
      "Azure/AppService"
    ],
    "x-kaytu-explanation": [
      "Managed service identity (MSI) is a feature provided by Azure App Service which helps to enhance the security of your applications. It allows an application to connect to other Azure services securely, without the need for specifying credentials like username and password in the connection strings. This minimizes the risk of revealing sensitive information.\n\nThe `ManagedIdentityCredential` class provided by Azure SDK helps in authenticating your application using managed identity. Here's an example:\n\n```xml\n\u003cManagedIdentityCredential Resource=\"https://management.azure.com\" /\u003e\n```\n\nIn the above markup, `ManagedIdentityCredential` is used to connect to the Azure Management service securely. The `Resource` attribute indicates the Azure service to which the app wants to connect.\n\nWhen your app requests a token from Azure AD for this resource, it is granted a token without needing to provide credentials. \n\nThis effectively removes credentials from your application source code, making it more secure. You don't have to worry about the risk of accidentally checking those secrets into a source control system, or having them stolen in case of a data breach. This provides one of the layers of defense-in-depth for your application's security."
    ],
    "x-kaytu-noncompliance-cost": [
      "Non-compliance to the Azure Control \"Managed Service Identity (MSI) in App Service\" can have significant cost. \n\n1. **Security Cost:** MSI eliminates the use of secrets in an app, like credentials in the connection strings. Non-compliance to this can lead to security vulnerabilities, as having usernames and passwords hard-coded or stored insecurely could potentially lead to unauthorized access, data breaches, and application exploits.\n\n2. **Administrative Cost:** If not using MSI, each service needs to be separately managed which can incur administrative burden from a cost, time, and effort perspective. With MSI, the identity is managed by Azure Active Directory, which simplifies identity administration. Non-compliance will result in added administrative overhead.\n\n3. **Financial Cost:** In case of a data breach due to non-compliance to the control, there can be financial consequences. This can include penalties for not meeting industry compliance regulations, potential lawsuits, loss of business, and efforts regarding remedy and protection against future attacks.\n\n4. **Reputational Cost:** A breach due to non-compliance can affect the reputation of the company negatively. This loss in customer and partner trust may lead to a decrease in business.\n\n5. **Audit Cost:** Non-compliance may result in increased audit scope, duration, and complexity. It could also lead to potential audit failures. \n\nOverall, non-compliance to the MSI in App Service Azure control will potentially increase the cost in terms of security, administration, reputation, and auditing."
    ],
    "x-kaytu-usefulness-example": [
      "Here is a use case example for Managed Service Identity in App Service:\n\n```markup\n - A web application hosted on the Azure App Service needs to access and retrieve information from a secure Azure SQL database.\n\n    - Traditionally, this would require the app to have the SQL database's connection string (including a username and password) hard-coded or stored somewhere it can reference. This approach is risky as the app's source code or configuration can be exposed or leaked, leading to potential security vulnerabilities.\n\n    - But with Azureâ€™s Managed service identity, this risk can be mitigated. When the App service is registered with Azure Active Directory, it is assigned an identity - akin to a service account - which can be used to authenticate with any service that supports Azure AD authentication.\n\n    - In our example, once the Azure SQL Database is configured to accept connections from the Azure AD identity of the App Service, the web app can connect to the database securely without needing a username and password. It can directly authenticate using its service identity.\n\n    - Therefore, the need for potentially vulnerable secrets in the app's code or configuration is eliminated, significantly enhancing the overall security.\n```\nThis example shows how Azure's Managed Service Identity in App Service can be effectively utilized to enhance the security of the applications by eliminating the need for sensitive information like usernames and passwords."
    ]
  },
  "Managed": true
}