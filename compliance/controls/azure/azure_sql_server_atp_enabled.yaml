Description: Enable "Azure Defender for SQL" on critical SQL Servers.
DocumentURI: ""
ID: azure_sql_server_atp_enabled
Managed: true
ManualVerification: false
Query:
  Connector: Azure
  Engine: odysseus-v0.0.1
  ListOfTables:
  - azure_sql_server
  - azure_subscription
  PrimaryTable: azure_sql_server
  QueryToExecute: |
    select
      s.id as resource,
      s.kaytu_account_id as kaytu_account_id,
      s.kaytu_resource_id as kaytu_resource_id,
      case
        when security -> 'properties' ->> 'state' = 'Disabled' then 'alarm'
        else 'ok'
      end as status,
      case
        when security -> 'properties' ->> 'state' = 'Disabled' then s.name || ' Azure defender disabled.'
        else s.name || ' Azure defender enabled.'
      end as reason
      
      , s.resource_group as resource_group
      , sub.display_name as subscription
    from
      azure_sql_server s,
      jsonb_array_elements(server_security_alert_policy) security,
      azure_subscription sub
    where
      sub.subscription_id = s.subscription_id;
Severity: critical
Tags:
  category:
  - Compliance
  cis:
  - "true"
  cis_item_id:
  - 4.2.1
  cis_level:
  - "2"
  cis_section_id:
  - "4.2"
  cis_type:
  - automated
  cis_version:
  - v1.3.0
  plugin:
  - azure
  service:
  - Azure/SQL
  x-kaytu-explanation:
  - "Azure Defender for SQL is a unified package for advanced SQL security capabilities. It provides a set of security features for detecting unusual and potentially harmful attempts to access or exploit SQL servers. \n\nActivating Azure Defender for SQL in your critical SQL servers is crucial because it provides advanced threat protection, vulnerability assessments, and SQL Server discovery and classification.\n\nHereâ€™s the Azure Policy in markup (JSON) format to enable Azure Defender for SQL:\n\n```json\n{\n  \"properties\": {\n    \"displayName\": \"Enable Azure Defender for SQL Servers on machines\",\n    \"policyType\": \"BuiltIn\",\n    \"mode\": \"All\",\n    \"description\": \"Enable Azure Defender for servers on SQL servers. Azure Defender for servers adds an extra layer of threat protection and provides just-in-time access and allows you to control and monitor access to your SQL virtual machines.\",\n    \"metadata\": {\n      \"version\": \"1.0.0\",\n      \"category\": \"Security Center\"\n    },\n    \"parameters\": {},\n    \"policyRule\": {\n      \"if\": {\n        \"field\": \"type\",\n        \"equals\": \"Microsoft.Sql/servers\"\n      },\n      \"then\": {\n        \"effect\": \"deployIfNotExists\",\n        \"details\": {\n          \"roleDefinitionIds\": [\n            \"/providers/microsoft.authorization/roleDefinitions/056cd41c-7e8f-4dbc-9e04-3c4f9d7d5a27\"\n          ],\n          \"type\": \"Microsoft.Security/serverVulnerabilityAssessments\",\n          \"existenceCondition\": {\n            \"field\": \"Microsoft.Security/serverVulnerabilityAssessments/SQL\",\n            \"equals\": \"Enabled\"\n          },\n          \"deployment\": {\n            \"properties\": {\n              \"parameters\": {\n                \"workspaceId\": {\n                  \"value\": \"[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]\"\n                },\n                \"vmId\": {\n                  \"value\": \"[field('id')]\"\n                }\n              },\n              \"template\": {\n                \"$schema\": \"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#\",\n                \"contentVersion\": \"1.0.0.0\",\n                \"parameters\": {\n                  \"workspaceName\": {\n                    \"type\": \"string\"\n                  },\n                  \"vmId\": {\n                    \"type\": \"string\"\n                  }\n                },\n                \"resources\": [\n                  {\n                    \"type\": \"Microsoft.Security/serverVulnerabilityAssessments\",\n                    \"apiVersion\": \"2019-01-01-preview\",\n                    \"name\": \"default\",\n                    \"dependsOn\": [],\n                    \"properties\": {}\n                  }\n                ],\n                \"outputs\": {}\n              }\n            }\n          }\n        }\n      }\n    }\n  },\n  \"id\": \"/providers/Microsoft.Authorization/policyDefinitions/26ee0fd7-fed4-4150-b5b4-04a3a74aa27a\",\n  \"type\": \"Microsoft.Authorization/policyDefinitions\",\n  \"name\": \"26ee0fd7-fed4-4150-b5b4-04a3a74aa27a\"\n}\n```\n\nThis policy will ensure that Azure Defender for SQL is enabled on your SQL servers providing superior defense capabilities against malicious threats."
  x-kaytu-noncompliance-cost:
  - "Non-compliance to the \"Azure Defender for SQL\" control can have the following cost implications:\n\n**Increased Security Risks** - The primary cost is increased vulnerability to cyber threats, including SQL injection attacks, brute force attacks, unauthorized access, or database hacking. These cyber threats can result in business disruption, data loss, or even a reputation impact, all of which have significant cost implications.\n\n**Financial losses** - In case of data breaches, organizations may face hefty fines for non-compliance with data protection regulations. The costs of recovery from attacks, including data recovery and system remediation, can also be substantial.\n\n**Loss of trust** - If customer data is compromised due to non-compliance, an organization can lose trust with its customers which can impact on revenues and customer loyalty.\n\n**Regulatory Non-compliance Penalties** - Depending on the jurisdiction, non-compliance with required cybersecurity measures such as turning on Azure Defender for SQL may result in regulatory fines and penalties.\n\n**Operational costs** - Without Azure Defender for SQL, more resources may need to be devoted to monitoring and managing security, including incident response and digital forensics. \n\n```markdown\n## Cost of Non-Compliance for \"Azure Defender for SQL\"\n\n1. **Increased Security Risks**: Non-compliance can lead to increased vulnerability to cyber threats. This can result in business disruption, data loss, and damage to the company's reputation.\n\n2. **Financial Losses**: In the event of data breaches, organizations could face hefty fines for non-compliance with data protection regulations and incur considerable costs for recovery from attacks.\n\n3. **Loss of Trust**: Non-compliance that results in a compromise of customer data can lead to a loss of trust, impacting both revenues and customer loyalty.\n\n4. **Regulatory Non-compliance Penalties**: Failure to enable appropriate cybersecurity measures like Azure Defender for SQL may result in regulatory fines and penalties.\n\n5. **Operational Costs**: Without proper Azure Defender for SQL, a business may need to expend more resources on monitoring and managing security. This includes the cost of incident response and digital forensics.\n```\nWithout proper security measures like Azure Defender for SQL, businesses may face significant costs in different areas, emphasizing the importance of compliance."
  x-kaytu-usefulness-example:
  - "In an enterprise environment, a company maintains a SQL server with a large amount of valuable data, which is the backbone of their operations. There is a significant risk of loss or damage to important business data due to cyber attacks or malicious activities. \n\nIn order to prevent this, the company can enable \"Azure Defender for SQL\" on this critical SQL Server. \n\n```\n\"resources\": [\n  {\n    \"name\": \"Azure Defender for SQL\",\n    \"type\": \"Microsoft.Security/pricings\",\n    \"apiVersion\": \"2020-01-01\",\n    \"properties\": {\n      \"pricingTier\": \"Standard\"\n    }\n  }\n]\n```\n\nThis action would provide an extra layer of security for the server by:\n\n- Detecting anomalous activities indicating unusual and potentially harmful attempts to access or exploit the SQL servers\n- Providing actionable security alerts along with recommendations on how to investigate and remediate threats.\n- Facilitating continuous security assessments that enable organisations to discover and mitigate potential vulnerabilities.\n- Monitoring the logs for any unusual activities or data breaches.\n\nThus, by enabling \"Azure Defender for SQL\", the company can achieve a secure environment for handling their critical data, thereby enhancing their business continuity and disaster recovery strategies."
Title: Ensure that Advanced Threat Protection (ATP) on a SQL server is set to 'Enabled'
