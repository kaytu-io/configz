Description: Create an activity log alert for the Create or Update Public IP Addresses rule.
DocumentURI: ""
ID: azure_monitor_log_alert_create_update_public_ip_address
Managed: true
ManualVerification: false
Query:
  Connector: Azure
  Engine: odysseus-v0.0.1
  ListOfTables:
  - azure_log_alert
  - azure_subscription
  PrimaryTable: azure_log_alert
  QueryToExecute: "with alert_rule as\n(\n  select\n    alert.id as alert_id,\n    alert.name as alert_name,\n    alert.enabled,\n    alert.location,\n    alert.subscription_id\n  from\n    azure_log_alert as alert,\n    jsonb_array_elements_text(scopes) as sc\n  where\n    alert.location = 'Global'\n    and alert.enabled\n    and sc = '/subscriptions/' || alert.subscription_id\n    and\n    (\n      ( alert.condition -> 'allOf' @> '[{\"equals\":\"Administrative\",\"field\":\"category\"}]'\n        and alert.condition -> 'allOf' @> '[{\"field\": \"resourceType\", \"equals\": \"microsoft.network/publicipaddresses\"}]'\n        and alert.condition -> 'allOf' @> '[{\"field\": \"operationName\", \"equals\": \"Microsoft.Network/publicIPAddresses/write\"}]'\n      )\n      or\n      (\n        alert.condition -> 'allOf' @> '[{\"equals\":\"Administrative\",\"field\":\"category\"}]'\n        and alert.condition -> 'allOf' @> '[{\"field\": \"resourceType\", \"equals\": \"microsoft.network/publicipaddresses\"}]'\n        and jsonb_array_length(alert.condition -> 'allOf') = 2\n      )\n    )\n    limit 1\n)\nselect\n  sub.subscription_id as resource,\n  sub.kaytu_account_id as kaytu_account_id,\n  sub.kaytu_resource_id as kaytu_resource_id,\n  case\n    when count(a.subscription_id) > 0 then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when count(a.subscription_id) > 0 then 'Activity Log Alert exists for Create or Update Public IP Address rule.'\n    else 'Activity Log Alert does not exists for Create or Update Public IP Address rule.'\n  end as reason\n  \n  , sub.display_name as subscription\nfrom\n  azure_subscription sub\n  left join alert_rule a on sub.subscription_id = a.subscription_id\ngroup by\n  sub.kaytu_account_id,\n  sub.kaytu_resource_id,\n  sub._ctx,\n  sub.subscription_id,\n  sub.display_name;\n"
Severity: high
Tags:
  category:
  - Compliance
  cis:
  - "true"
  cis_item_id:
  - 5.2.9
  cis_level:
  - "1"
  cis_section_id:
  - "5.2"
  cis_type:
  - automated
  cis_version:
  - v1.5.0
  plugin:
  - azure
  service:
  - Azure/Monitor
  x-kaytu-explanation:
  - "## Azure Activity Log Alert Configuration\n\nTo enhance monitoring and security, it is advisable to set up activity log alerts in Azure. Follow the steps below to create an activity log alert specifically for the \"Create or Update Public IP Addresses\" rule.\n\n### Prerequisites\n\nBefore proceeding, ensure that you have the necessary permissions and access to Azure portal.\n\n### Steps\n\n1. **Navigate to the Azure Portal:**\n   Open your web browser and go to the [Azure Portal](https://portal.azure.com/).\n\n2. **Access the Activity Log:**\n   - In the left navigation pane, click on the \"Monitor\" tab.\n   - Under the \"Monitoring solutions\" section, select \"Activity log.\"\n\n3. **Create a New Activity Log Alert:**\n   - Click on the \"Alerts\" option in the Activity log menu.\n   - Click on the \"+ Add activity log alert\" button.\n\n4. **Configure Alert Details:**\n   - In the \"Basics\" tab, provide a meaningful name for the alert in the \"Alert rule name\" field.\n   - Choose the appropriate subscription for the alert.\n   - Set the \"Resource group\" to the relevant resource group.\n\n5. **Define Conditions:**\n   - In the \"Condition\" tab, set the condition to trigger the alert.\n     - For the \"Event name\" field, select \"Create or Update Public IP Addresses\" from the dropdown.\n     - Define other conditions based on your monitoring requirements.\n\n6. **Define Actions:**\n   - In the \"Actions\" tab, specify the actions to take when the alert is triggered.\n     - Choose an action group or configure a new one to receive notifications or perform specific tasks.\n\n7. **Review and Create:**\n   - Review the configuration settings in the \"Review + create\" tab.\n   - Click on the \"Create\" button to deploy the activity log alert.\n\n8. **Verification:**\n   - Once the alert is created, navigate back to the \"Alerts\" section in the Activity log to verify its presence.\n   - Test the alert by simulating the triggering condition and confirming that the configured actions are executed.\n\nBy following these steps, you have successfully created an activity log alert for the \"Create or Update Public IP Addresses\" rule in Azure, enhancing your ability to respond promptly to relevant events and maintain the security of your resources.\n"
  x-kaytu-noncompliance-cost:
  - "**Cost of Non-Compliance: Create or Update Public IP Addresses Rule**\n\n1. **Financial Penalties:** Non-compliance may result in financial penalties, as organizations failing to monitor and alert on the creation or update of Public IP Addresses may inadvertently expose resources to unauthorized access or compromise.\n\n2. **Security Risks:** Without a proper activity log alert, there is a heightened risk of unauthorized changes to Public IP Addresses, leading to potential security breaches, data leaks, or service disruptions.\n\n3. **Regulatory Violations:** Failure to implement the specified activity log alert may result in non-compliance with industry regulations and standards. This can lead to legal consequences, fines, or other regulatory actions.\n\n4. **Operational Disruptions:** In the absence of timely alerts, operational disruptions may occur due to unnoticed changes to Public IP Addresses. This can impact the availability and reliability of services hosted on Azure.\n\n5. **Reputation Damage:** Security incidents resulting from non-compliance can tarnish the reputation of the organization. Loss of trust from customers, partners, and stakeholders may have long-term consequences.\n\n**Mitigation Steps:**\n\nTo mitigate these risks, it is crucial to:\n\n- **Configure Activity Log Alerts:** Set up and configure activity log alerts specifically for the creation or update of Public IP Addresses to ensure immediate detection of any such changes.\n\n- **Regularly Review Alerts:** Regularly review and analyze the generated alerts to identify and respond promptly to any suspicious activities related to Public IP Addresses.\n\n- **Implement Access Controls:** Strengthen access controls and permissions to minimize the likelihood of unauthorized changes.\n\n- **Stay Informed:** Stay informed about Azure best practices and updates to ensure continued compliance with security standards.\n\nBy proactively addressing these considerations, organizations can reduce the risk and potential costs associated with non-compliance to the specified Azure control.\n"
  x-kaytu-usefulness-example:
  - "To create an Activity Log alert for the \"Create or Update Public IP Addresses\" rule in Azure, you can use Azure Resource Manager (ARM) templates. Below is an example ARM template in JSON format:\n\njson\n{\n  \"$schema\": \"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#\",\n  \"contentVersion\": \"1.0.0.0\",\n  \"resources\": [\n    {\n      \"type\": \"Microsoft.Insights/activityLogAlerts\",\n      \"apiVersion\": \"2017-04-01\",\n      \"name\": \"PublicIPAlert\",\n      \"location\": \"global\",\n      \"properties\": {\n        \"displayName\": \"Activity Log Alert for Create or Update Public IP Addresses\",\n        \"description\": \"Alert triggered when a Public IP Address is created or updated\",\n        \"enabled\": true,\n        \"scopes\": [\"/subscriptions/{subscriptionId}\"],\n        \"condition\": {\n          \"allOf\": [\n            {\n              \"field\": \"category\",\n              \"equals\": \"Administrative\"\n            },\n            {\n              \"field\": \"operationName\",\n              \"equals\": \"Microsoft.Network/publicIPAddresses/write\"\n            },\n            {\n              \"field\": \"level\",\n              \"equals\": \"Informational\"\n            }\n          ]\n        },\n        \"actions\": {\n          \"actionGroups\": [\n            {\n              \"actionGroupId\": \"/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Insights/actionGroups/{actionGroupId}\"\n            }\n          ]\n        }\n      }\n    }\n  ]\n}\nIn this example:\n\nReplace {subscriptionId} with your Azure subscription ID.\nReplace {resourceGroupName} with the resource group where you want to deploy the alert.\nReplace {actionGroupId} with the ID of the action group you want to associate with this alert.\nThis ARM template creates an Activity Log alert named \"PublicIPAlert\" that triggers when a Public IP Address is created or updated. It is configured to send notifications to an Azure Action Group.\n\nRemember to deploy this template using the Azure Portal, Azure CLI, or any other suitable deployment method. After deployment, the alert will be active and notify the specified action group whenever the defined conditions are met."
Title: Ensure that Activity Log Alert exists for Create or Update Public IP Address rule
