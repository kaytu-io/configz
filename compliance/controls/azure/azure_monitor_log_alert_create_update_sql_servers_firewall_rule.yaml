Description: Create an activity log alert for the Create or Update SQL Server Firewall Rule event.
DocumentURI: ""
ID: azure_monitor_log_alert_create_update_sql_servers_firewall_rule
Managed: true
ManualVerification: false
Query:
  Connector: Azure
  Engine: odysseus-v0.0.1
  ListOfTables:
  - azure_log_alert
  - azure_subscription
  PrimaryTable: azure_log_alert
  QueryToExecute: "with alert_rule as\n(\n  select\n    alert.id as alert_id,\n    alert.name as alert_name,\n    alert.enabled,\n    alert.location,\n    alert.subscription_id\n  from\n    azure_log_alert as alert,\n    jsonb_array_elements_text(scopes) as sc\n  where\n    alert.location = 'Global'\n    and alert.enabled\n    and sc = '/subscriptions/' || alert.subscription_id\n    and\n    (\n      ( alert.condition -> 'allOf' @> '[{\"equals\":\"Administrative\",\"field\":\"category\"}]'\n      and alert.condition -> 'allOf' @> '[{\"field\": \"resourceType\", \"equals\": \"microsoft.sql/servers/firewallrules\"}]'\n      and alert.condition -> 'allOf' @> '[{\"field\": \"operationName\", \"equals\": \"Microsoft.Sql/servers/firewallRules/write\"}]'\n      )\n      or\n      (\n        alert.condition -> 'allOf' @> '[{\"equals\":\"Administrative\",\"field\":\"category\"}]'\n        and alert.condition -> 'allOf' @> '[{\"field\": \"resourceType\", \"equals\": \"microsoft.sql/servers/firewallrules\"}]'\n        and jsonb_array_length(alert.condition -> 'allOf') = 2\n      )\n    )\n    limit 1\n)\nselect\n  sub.subscription_id as resource,\n  sub.kaytu_account_id as kaytu_account_id,\n  sub.kaytu_resource_id as kaytu_resource_id,\n  case\n    when count(a.subscription_id) > 0 then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when count(a.subscription_id) > 0 then 'Activity Log Alert exists for Create or Update SQL Server Firewall Rule.'\n    else 'Activity Log Alert does not exists for Create or Update SQL Server Firewall Rule.'\n  end as reason\n  \n  , sub.display_name as subscription\nfrom\n  azure_subscription sub\n  left join alert_rule a on sub.subscription_id = a.subscription_id\ngroup by\n  sub.kaytu_account_id,\n  sub.kaytu_resource_id,\n  sub._ctx,\n  sub.subscription_id,\n  sub.display_name;\n"
Severity: medium
Tags:
  category:
  - Compliance
  cis:
  - "true"
  cis_item_id:
  - 5.2.7
  cis_level:
  - "1"
  cis_section_id:
  - "5.2"
  cis_type:
  - automated
  cis_version:
  - v1.5.0
  plugin:
  - azure
  service:
  - Azure/Monitor
  x-kaytu-explanation:
  - "# Azure Activity Log Alert Setup\n\n## Overview\n\nThis guide provides step-by-step instructions for creating an Activity Log Alert in Azure, specifically for the \"Create or Update SQL Server Firewall Rule\" event. Activity Log Alerts help you stay informed about activities that occur within your Azure resources.\n\n## Steps\n\n1. **Navigate to Azure Portal:**\n   - Open your web browser and go to the [Azure Portal](https://portal.azure.com/).\n\n2. **Access Activity Log:**\n   - In the left navigation pane, select the \"Monitor\" tab.\n   - Under \"Monitoring,\" select \"Activity log.\"\n\n3. **Filter Activity Log:**\n   - Use the filter options to narrow down the events.\n   - Choose the appropriate subscription, resource group, and time range.\n\n4. **Define Filter Criteria:**\n   - Click on the \"Add filter\" button.\n   - Set the filter to include the \"Create or Update SQL Server Firewall Rule\" event.\n\n5. **Create Alert Rule:**\n   - Click on the \"New alert rule\" button.\n   - Specify a unique name for the alert rule.\n\n6. **Set Conditions:**\n   - Configure the conditions for the alert. This might include setting a threshold for the number of occurrences within a specified time frame.\n\n7. **Define Actions:**\n   - Choose the actions to be taken when the alert conditions are met. This could include sending an email notification, triggering an Azure Function, or other custom actions.\n\n8. **Review and Create:**\n   - Review your alert rule settings.\n   - Click \"Create\" to save and activate the alert.\n\n9. **Validation:**\n   - Perform a test action that triggers the \"Create or Update SQL Server Firewall Rule\" event.\n   - Confirm that the alert is triggered and the defined actions are executed.\n\n## Conclusion\n\nBy following these steps, you have successfully created an Activity Log Alert in Azure specifically tailored for the \"Create or Update SQL Server Firewall Rule\" event. This proactive monitoring approach helps you respond promptly to relevant activities within your Azure environment.\n"
  x-kaytu-noncompliance-cost:
  - "# Cost of Non-Compliance: Create or Update SQL Server Firewall Rule Event\n\n## Control Description:\nEnsure the creation of an activity log alert for the \"Create or Update SQL Server Firewall Rule\" event in Azure.\n\n## Implications of Non-Compliance:\n\n1. **Security Risks:**\n   - Without an activity log alert, unauthorized changes to SQL Server Firewall Rules may go unnoticed.\n   - Lack of monitoring increases the risk of malicious actors gaining unauthorized access to the SQL Server.\n\n2. **Delayed Response:**\n   - In the absence of real-time alerts, the detection and response time to firewall rule changes may be delayed.\n   - Delays in identifying and mitigating unauthorized changes can lead to extended periods of vulnerability.\n\n3. **Compliance Violations:**\n   - Non-compliance may result in violations of regulatory requirements and industry standards related to data security.\n   - Failure to monitor and report on firewall rule changes could lead to audit failures.\n\n4. **Operational Impact:**\n   - Untracked changes may impact the stability and performance of the SQL Server environment.\n   - Operational issues arising from unmonitored changes can lead to downtime and affect business continuity.\n\n## Recommended Action:\n\nImplement an Azure Policy and set up an activity log alert for the \"Create or Update SQL Server Firewall Rule\" event. This involves:\n\n```azurecli\n# Sample Azure CLI commands for creating an activity log alert\naz monitor activity-log alert create --name <AlertName> --description \"Alert for SQL Server Firewall Rule changes\" --condition category=Administrative --operationName Microsoft.Sql/servers/firewallRules/write --level Error --status Enabled --actions <ActionGroupResourceId>\n"
  x-kaytu-usefulness-example:
  - "To create an activity log alert for the \"Create or Update SQL Server Firewall Rule\" event in Azure, you can use Azure Policy. Below is an example of how you can define this policy in Azure Policy markup format:\n\njson\n{\n  \"mode\": \"All\",\n  \"policyRule\": {\n    \"if\": {\n      \"allOf\": [\n        {\n          \"field\": \"type\",\n          \"equals\": \"Microsoft.Sql/servers/firewallRules\"\n        },\n        {\n          \"field\": \"Microsoft.Sql/servers/firewallRules/action\",\n          \"in\": [\"Microsoft.Sql/servers/firewallRules/write\"]\n        }\n      ]\n    },\n    \"then\": {\n      \"effect\": \"deployIfNotExists\",\n      \"details\": {\n        \"type\": \"Microsoft.Insights/activityLogAlerts\",\n        \"existenceCondition\": {\n          \"field\": \"Microsoft.Insights/activityLogAlerts/name\",\n          \"exists\": \"false\"\n        },\n        \"roleDefinitionIds\": [\n          \"/providers/microsoft.authorization/roleDefinitions/{your_custom_role_definition_id}\"\n        ],\n        \"deploymentScope\": \"ResourceGroup\", \n        \"deploymentAction\": \"Incremental\",\n        \"deployIfNotExists\": {\n          \"parameters\": {\n            \"actionGroupResourceIds\": {\n              \"value\": [\n                \"/subscriptions/{subscription-id}/resourceGroups/{resource-group}/providers/Microsoft.Insights/actionGroups/{action-group-name}\"\n              ]\n            },\n            \"disabled\": {\n              \"value\": false\n            },\n            \"description\": {\n              \"value\": \"Alert for Create or Update SQL Server Firewall Rule\"\n            }\n          },\n          \"template\": {\n            \"$schema\": \"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#\",\n            \"contentVersion\": \"1.0.0.0\",\n            \"resources\": [\n              {\n                \"type\": \"Microsoft.Insights/activityLogAlerts\",\n                \"apiVersion\": \"2017-04-01\",\n                \"name\": \"{your-alert-name}\",\n                \"location\": \"Global\",\n                \"properties\": {\n                  \"displayName\": \"Create or Update SQL Server Firewall Rule Alert\",\n                  \"description\": \"Alert for Create or Update SQL Server Firewall Rule\",\n                  \"enabled\": true,\n                  \"scopes\": [],\n                  \"condition\": {\n                    \"allOf\": [\n                      {\n                        \"field\": \"category\",\n                        \"equals\": \"Administrative\"\n                      },\n                      {\n                        \"field\": \"operationName\",\n                        \"equals\": \"Microsoft.Sql/servers/firewallRules/write\"\n                      }\n                    ]\n                  },\n                  \"actions\": {\n                    \"actionGroups\": [\n                      {\n                        \"actionGroupId\": \"/subscriptions/{subscription-id}/resourceGroups/{resource-group}/providers/Microsoft.Insights/actionGroups/{action-group-name}\"\n                      }\n                    ]\n                  }\n                }\n              }\n            ]\n          }\n        }\n      }\n    }\n  },\n  \"parameters\": {}\n}\nMake sure to replace placeholders like {your_custom_role_definition_id}, {subscription-id}, {resource-group}, {action-group-name}, and {your-alert-name} with your actual values.\n\nThis Azure Policy ensures that an activity log alert is created whenever a \"Create or Update SQL Server Firewall Rule\" event occurs, and it is associated with a specified action group for notification."
Title: Ensure that Activity Log Alert exists for Create or Update SQL Server Firewall Rule
