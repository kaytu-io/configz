Description: Create an activity log alert for the 'Delete SQL Server Firewall Rule.'
DocumentURI: ""
ID: azure_monitor_log_alert_delete_sql_servers_firewall_rule
Managed: true
ManualVerification: false
Query:
  Connector: Azure
  Engine: odysseus-v0.0.1
  ListOfTables:
  - azure_log_alert
  - azure_subscription
  PrimaryTable: azure_log_alert
  QueryToExecute: "with alert_rule as(\n  select\n    alert.id as alert_id,\n    alert.name as alert_name,\n    alert.enabled,\n    alert.location,\n    alert.subscription_id\n  from\n    azure_log_alert as alert,\n    jsonb_array_elements_text(scopes) as sc\n  where\n    alert.location = 'Global'\n    and alert.enabled\n    and sc = '/subscriptions/' || alert.subscription_id\n    and\n    (\n      ( alert.condition -> 'allOf' @> '[{\"equals\":\"Administrative\",\"field\":\"category\"}]'\n      and alert.condition -> 'allOf' @> '[{\"field\": \"resourceType\", \"equals\": \"microsoft.sql/servers/firewallrules\"}]'\n      and alert.condition -> 'allOf' @> '[{\"field\": \"operationName\", \"equals\": \"Microsoft.Sql/servers/firewallRules/delete\"}]' )\n      or\n      (\n        alert.condition -> 'allOf' @> '[{\"equals\":\"Administrative\",\"field\":\"category\"}]'\n        and alert.condition -> 'allOf' @> '[{\"field\": \"resourceType\", \"equals\": \"microsoft.sql/servers/firewallrules\"}]'\n        and jsonb_array_length(alert.condition -> 'allOf') = 2\n      )\n    )\n    limit 1\n)\nselect\n  sub.subscription_id as resource,\n  sub.kaytu_account_id as kaytu_account_id,\n  sub.kaytu_resource_id as kaytu_resource_id,\n  case\n    when count(a.subscription_id) > 0 then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when count(a.subscription_id) > 0 then 'Activity Log Alert exists for Delete SQL Server Firewall Rule.'\n    else 'Activity Log Alert does not exists for Delete SQL Server Firewall Rule.'\n  end as reason\n  \n  , sub.display_name as subscription\nfrom\n  azure_subscription sub\n  left join alert_rule a on sub.subscription_id = a.subscription_id\ngroup by\n  sub.kaytu_account_id,\n  sub.kaytu_resource_id,\n  sub._ctx,\n  sub.subscription_id,\n  sub.display_name;\n"
Severity: high
Tags:
  category:
  - Compliance
  cis:
  - "true"
  cis_item_id:
  - 5.2.8
  cis_level:
  - "1"
  cis_section_id:
  - "5.2"
  cis_type:
  - automated
  cis_version:
  - v1.5.0
  plugin:
  - azure
  service:
  - Azure/Monitor
  x-kaytu-explanation:
  - "# Azure Control: Create Activity Log Alert\n\n## Description\n\nThis guide outlines the steps to create an activity log alert in Azure for the specific event of 'Delete SQL Server Firewall Rule.' Activity log alerts help you stay informed about critical activities and changes within your Azure resources.\n\n## Steps\n\n1. **Navigate to Azure Portal:**\n   Open your web browser and go to the [Azure Portal](https://portal.azure.com/).\n\n2. **Access Activity Log:**\n   - In the left sidebar, click on the \"Monitor\" tab.\n   - Under the \"Monitoring\" section, select \"Activity log.\"\n\n3. **Create New Alert Rule:**\n   - Click on the \"Alerts\" option in the left menu.\n   - Select the \"New alert rule\" button.\n\n4. **Choose Resource:**\n   - In the \"Scope\" section, choose the specific subscription or resource group where your SQL Server is located.\n\n5. **Define Condition:**\n   - Under the \"Condition\" tab, choose the condition that triggers the alert. In this case, select the specific operation, such as 'Delete SQL Server Firewall Rule.'\n   - Set the other relevant conditions based on your requirements.\n\n6. **Set Action Group:**\n   - In the \"Actions\" tab, configure the action to be taken when the alert is triggered. This may include sending an email, triggering a webhook, or other notifications.\n   - You can create a new action group if needed.\n\n7. **Define Alert Details:**\n   - Under the \"Alert details\" tab, provide a meaningful name and description for your alert.\n   - Set the severity level based on the importance of the event.\n\n8. **Review and Create:**\n   - Review your settings to ensure they match your requirements.\n   - Click the \"Create alert rule\" button to save and activate the alert.\n\n9. **Verification:**\n   - To verify that the alert is working correctly, perform a test action that matches the specified conditions (e.g., delete a SQL Server Firewall Rule).\n   - Check the configured notification channels for alerts.\n\n## Conclusion\n\nBy following these steps, you have successfully created an activity log alert in Azure to notify you when a 'Delete SQL Server Firewall Rule' event occurs. This proactive approach enhances your ability to monitor and respond to critical changes in your Azure environment.\n"
  x-kaytu-noncompliance-cost:
  - "### Azure Control: Activity Log Alert for 'Delete SQL Server Firewall Rule'\n\n#### Description:\nEnsure that an activity log alert is configured to detect and notify any attempt to delete a SQL Server Firewall Rule within the Azure environment.\n\n#### Non-Compliance Cost:\n\n- **Operational Impact:**\n  - Without the alert, unauthorized deletions of SQL Server Firewall Rules may go unnoticed.\n  - Increased risk of security breaches and potential unauthorized access to SQL Server instances.\n\n- **Regulatory Compliance:**\n  - Non-compliance may result in violations of regulatory requirements related to data security and access controls.\n\n- **Data Integrity and Availability:**\n  - Unmonitored deletions may lead to disruptions in services and potential data loss.\n\n#### Mitigation:\n\n- Configure Azure Policy or Azure Security Center to create an activity log alert for the specified action.\n- Ensure that the alert triggers appropriate notifications or automated responses.\n- Regularly review and update the alert configuration based on evolving security requirements.\n\n#### Monitoring and Enforcement:\n\n- Regularly monitor alerts and investigate any triggered alerts promptly.\n- Conduct periodic audits to ensure ongoing compliance with the configured alert.\n\n#### Compliance Verification:\n\n- Implement a process for regularly validating the effectiveness of the alert.\n- Conduct internal or external audits to verify compliance with the established control.\n\n#### Cost of Non-Compliance Example:\n\nAssuming a security breach occurs due to the unauthorized deletion of a SQL Server Firewall Rule:\n- Potential financial losses due to data breaches, legal consequences, and reputational damage.\n- Costs associated with investigating and mitigating the security incident.\n\n"
  x-kaytu-usefulness-example:
  - "To create an activity log alert for the 'Delete SQL Server Firewall Rule' in Azure, you can use Azure Resource Manager (ARM) templates to define your Azure resources. Below is an example of an ARM template snippet that creates an activity log alert for the specified action:\n\njson\n\n{\n  \"$schema\": \"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#\",\n  \"contentVersion\": \"1.0.0.0\",\n  \"resources\": [\n    {\n      \"type\": \"Microsoft.Insights/activityLogAlerts\",\n      \"apiVersion\": \"2017-03-01-preview\",\n      \"name\": \"firewallRuleDeletionAlert\",\n      \"location\": \"global\",\n      \"properties\": {\n        \"enabled\": true,\n        \"scopes\": [\"/subscriptions/{subscriptionId}\"],\n        \"condition\": {\n          \"allOf\": [\n            {\n              \"field\": \"category\",\n              \"equals\": \"Administrative\"\n            },\n            {\n              \"field\": \"operationName\",\n              \"equals\": \"Microsoft.Sql/servers/firewallRules/delete\"\n            }\n          ]\n        },\n        \"actions\": {\n          \"actionGroups\": [\n            {\n              \"actionGroupId\": \"/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Insights/actionGroups/{actionGroupName}\"\n            }\n          ]\n        }\n      }\n    }\n  ]\n}\nPlease replace the placeholder values such as {subscriptionId}, {resourceGroupName}, and {actionGroupName} with your actual subscription ID, resource group name, and action group name.\n\nThis ARM template creates an activity log alert that is triggered when the category is \"Administrative\" and the operation name is \"Microsoft.Sql/servers/firewallRules/delete.\" The alert is associated with an action group that you need to define separately, specifying the actions to be taken when the alert is triggered (e.g., sending an email, triggering a webhook, etc.).\n\nEnsure that you have the necessary permissions to create activity log alerts and manage resources in Azure. You can deploy this template using the Azure Portal, Azure CLI, or other Azure management tools."
Title: Ensure that Activity Log Alert exists for Delete SQL Server Firewall Rule
