Description: Set audit_log_enabled to include CONNECTION on MySQL Servers.
DocumentURI: ""
ID: azure_mysql_server_audit_logging_events_connection_set
Managed: true
ManualVerification: false
Query:
  Connector: Azure
  Engine: odysseus-v0.0.1
  ListOfTables:
  - azure_mysql_server
  - azure_subscription
  PrimaryTable: azure_mysql_server
  QueryToExecute: |
    select
      s.id as resource,
      s.kaytu_account_id as kaytu_account_id,
      s.kaytu_resource_id as kaytu_resource_id,
      case
        when lower(config -> 'ConfigurationProperties' ->> 'value') = 'connection' then 'ok'
        else 'alarm'
      end as status,
      case
        when lower(config -> 'ConfigurationProperties' ->> 'value') = 'connection' then s.name || ' server parameter audit_log_events has connection set.'
        else s.name || ' server parameter audit_log_events connection not set.'
      end as reason
      
      , s.resource_group as resource_group
      , sub.display_name as subscription
    from
      azure_mysql_server as s,
      jsonb_array_elements(server_configurations) config,
      azure_subscription sub
    where
      config ->> 'Name' = 'audit_log_events'
      and sub.subscription_id = s.subscription_id;
Severity: medium
Tags:
  category:
  - Compliance
  cis:
  - "true"
  cis_item_id:
  - 4.4.4
  cis_level:
  - "2"
  cis_section_id:
  - "4.4"
  cis_type:
  - manual
  cis_version:
  - v1.5.0
  plugin:
  - azure
  service:
  - Azure/MySQL
  x-kaytu-explanation:
  - "Azure's auditing feature tracks database events and writes them to an audit log file. These logs could be used for troubleshooting, monitoring security incidents, regulatory compliance, etc. In Markup or code format, suppose you want to implement Control settings such that connection to MySQL servers is included in audit logs, it can be represented as:\n\n```xml\n<control name=\"AuditLogOnMysql\">\n  <enabled value=\"true\"/>\n  <settings>\n    <retentionPeriod value=\"7\"/>\n    <storageAccountName value=\"storageAccount\"/>\n    <storageAccountAccessKey value=\"accessKey\"/>\n    <auditActionsAndGroups>\n      <actionGroup value=\"CONNECTION\"/>\n    </auditActionsAndGroups>\n  </settings>\n</control>\n```\nIn this markup format :\n\n- The enabled attribute is set to true, meaning audit log settings are on.\n- Under settings: \n  - Retention period is how long the logs will be kept before they are deleted, which has been set to 7 days.\n  - StorageAccountName and StorageAccountAccessKey are set to refer to where these logs will be kept.\n- 'auditActionsAndGroups' is where you specify the group of actions to be audited. Here the value 'CONNECTION' is set, so the server will record events whenever a user connects or disconnects from the database.\n\nThis is a generic representation. Replace `storageAccount` and `accessKey` with your actual Azure storage account's name and key. Though it is XML format but the essence is the same for other markup languages.\n\nRemember to use Azure SDK to enforce this setting as per the prescribed format. Also note that this feature is available only for advanced threat protection enabled servers on Azure."
  x-kaytu-noncompliance-cost:
  - "The `audit_log_enabled` setting in Azure MySQL Services ensures that all activities on your MySQL Server are logged and available for review, which includes connection events. This can be critical in investigating any unauthorized or malicious activity on your MySQL Servers. \n\nThe cost of non-compliance to this control are:\n\n- **Security Risks**: Without tracking and logging connection events, detecting intrusion attempts or successful unauthorized accesses can be difficult. This leaves your database vulnerable to security threats and may result in data breaches.\n\n- **Regulatory Fines**: Most industries require strict audit logs for regulatory compliance. Not being compliant with this requirement can lead to hefty regulatory fines and penalties.\n\n- **Loss of Trust**: Users or clients who entrust personal or sensitive data to you may lose trust in your services if a data breach occurs due to inadequate audit logging.\n\n- **Investigation Difficulties**: In the case of a system anomaly or issue, the lack of proper logs can make it extremely difficult for your team to investigate and find the root cause.\n\n- **Operational Costs**: Without having a clear and structured log of connections, diagnosing operational or performance issues can be more time consuming and therefore costlier.\n\nTo mitigate these costs, it is crucial that `audit_log_enabled` is set to include the `CONNECTION` on the MySQL servers."
  x-kaytu-usefulness-example:
  - "In Azure Database for MySQL Servers, setting the `audit_log_enabled` property to include `CONNECTION` allows for an extensive log of all connection attempts, successful or not, within the MySQL server instance. This is a useful control as it can enhance security and compliance within an organization by ensuring unauthorized access attempts are recorded and can be addressed promptly.\n\nExample:\n```markdown\n# Set audit_log_enabled to include CONNECTION on Azure MySQL Server\n\nAssume a scenario where an organization has a strict policy to monitor all connections to their MySQL servers due to security reasons. They aim to ensure that all login attempts, both successful and failed, are thoroughly tracked. \n\nThey can achieve this by setting `audit_log_enabled` to include `CONNECTION` on Azure MySQL server. This provides a comprehensive audit log capturing all connection attempts to their MySQL Server, which is beneficial in:\n\n1. **Detecting security incidents**: Unexpected or unauthorized connection attempts can indicate a potential security threat like a hacking attempt.\n2. **Troubleshooting**: Audit logs can aid in identifying issues related to connection errors, helping to ensure uninterrupted database service.\n3. **Compliance**: Many organizations are required to keep comprehensive logs for regulatory compliance. This feature can support these requirements.\n  \nNote: Connection logs can contain sensitive data, so make sure you manage and store them securely following your company's data security policy.\n```"
Title: Ensure server parameter 'audit_log_events' has 'CONNECTION' set for MySQL Database Server
