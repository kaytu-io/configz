Description: Create an activity log alert for the Create Policy Assignment event.
DocumentURI: ""
ID: azure_monitor_log_alert_create_policy_assignment
Managed: true
ManualVerification: false
Query:
  Connector: Azure
  Engine: odysseus-v0.0.1
  ListOfTables:
  - azure_log_alert
  - azure_subscription
  PrimaryTable: azure_log_alert
  QueryToExecute: "with alert_rule as (\n  select\n    alert.id as alert_id,\n    alert.name as alert_name,\n    alert.kaytu_account_id as kaytu_account_id,\n    alert.kaytu_resource_id as kaytu_resource_id,\n    alert.enabled,\n    alert.location,\n    alert.subscription_id\n  from\n    azure_log_alert as alert,\n    jsonb_array_elements_text(scopes) as sc\n  where\n    alert.location = 'Global'\n    and alert.enabled\n    and sc = '/subscriptions/' || alert.subscription_id\n    and alert.condition -> 'allOf' @> '[{\"equals\":\"Administrative\",\"field\":\"category\"}]'\n    and alert.condition -> 'allOf' @> '[{\"field\": \"resourceType\", \"equals\": \"microsoft.authorization/policyassignments\"}]'\n    and alert.condition -> 'allOf' @> '[{\"field\": \"operationName\", \"equals\": \"Microsoft.Authorization/policyAssignments/write\"}]'\n  limit 1\n)\nselect\n  sub.subscription_id as resource,\n  sub.kaytu_account_id as kaytu_account_id,\n  sub.kaytu_resource_id as kaytu_resource_id,\n  case\n    when count(a.subscription_id) > 0 then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when count(a.subscription_id) > 0 then 'Activity log alert exists for create policy assignment event.'\n    else 'Activity log alert does not exists for create policy assignment event.'\n  end as reason\n  \n  , sub.display_name as subscription\nfrom\n  azure_subscription sub\n  left join alert_rule a on sub.subscription_id = a.subscription_id\ngroup by\n  sub.subscription_id,\n  sub.kaytu_account_id,\n  sub.kaytu_resource_id,\n  sub._ctx,\n  sub.display_name;\n"
Severity: medium
Tags:
  category:
  - Compliance
  cis:
  - "true"
  cis_item_id:
  - 5.2.1
  cis_level:
  - "1"
  cis_section_id:
  - "5.2"
  cis_type:
  - automated
  cis_version:
  - v1.3.0
  plugin:
  - azure
  service:
  - Azure/Monitor
  x-kaytu-explanation:
  - "# Azure Control Markup\n\n- **Task:** Create Activity Log Alert for Create Policy Assignment Event\n\n- **Description:** This markup represents the steps to create an activity log alert in Azure for the \"Create Policy Assignment\" event using Azure Policy and Azure Monitor.\n\n- **Steps:**\n  1. **Open Azure Portal:**\n     ```yaml\n     - Open [Azure Portal](https://portal.azure.com/).\n     ```\n\n  2. **Navigate to Azure Policy:**\n     ```yaml\n     - Navigate to the \"Azure Policy\" service.\n     ```\n\n  3. **Create a Policy Definition:**\n     ```yaml\n     - Create a policy definition that includes the condition for the \"Create Policy Assignment\" event.\n     ```\n\n  4. **Assign the Policy:**\n     ```yaml\n     - Assign the policy to the appropriate scope (subscription, resource group, or resource).\n     ```\n\n  5. **Configure Diagnostic Settings:**\n     ```yaml\n     - Configure diagnostic settings for the target resource to send activity logs to Azure Monitor.\n     ```\n\n  6. **Create Activity Log Alert:**\n     ```yaml\n     - Navigate to Azure Monitor and create an activity log alert.\n     - Set the alert rule conditions to trigger on the \"Create Policy Assignment\" event.\n     - Define the alert actions (e.g., email notification, webhook).\n     ```\n\n  7. **Review and Save:**\n     ```yaml\n     - Review the alert configuration and save the changes.\n     ```\n\n- **Note:**\n  - Make sure you have the necessary permissions to create and manage policies, policy assignments, and activity log alerts in the Azure subscription.\n"
  x-kaytu-noncompliance-cost:
  - "### Cost of Non-Compliance: Missing Activity Log Alert for Create Policy Assignment Event\n\n**Description:**\nFailure to create an activity log alert for the \"Create Policy Assignment\" event in Azure can lead to several potential costs and risks.\n\n**1. Security Risks:**\n   - Without a dedicated alert for policy assignment creation, security incidents related to unauthorized policy changes may go unnoticed.\n   - Lack of timely alerts can result in delayed response to potential security breaches.\n\n**2. Compliance Violations:**\n   - Non-compliance with regulatory requirements that mandate monitoring and alerting for critical events, including policy assignment changes.\n   - Auditors may identify the absence of this control, leading to potential fines or penalties.\n\n**3. Operational Impact:**\n   - Difficulty in tracking and troubleshooting policy assignment-related issues without specific alerts.\n   - Increased mean time to detection and resolution of incidents, affecting overall operational efficiency.\n\n**4. Missed Governance Opportunities:**\n   - Inability to enforce governance policies promptly, leading to misconfigurations or deviations from organizational standards.\n   - Diminished ability to maintain a secure and compliant Azure environment.\n\n**5. Reputation Damage:**\n   - Public perception of inadequate security and compliance practices, potentially damaging the organization's reputation.\n   - Loss of trust from customers, partners, and stakeholders.\n\n**6. Increased Remediation Costs:**\n   - Identifying and addressing policy violations retroactively can be more time-consuming and costly than addressing them proactively with real-time alerts.\n   - Greater resources required for incident response and remediation efforts.\n\n**Recommendation:**\nTo mitigate these risks and associated costs, it is crucial to implement an activity log alert specifically for the \"Create Policy Assignment\" event. Ensure that the alerting mechanism is configured with appropriate thresholds and notification channels for timely response and resolution.\n\n**Implementation Steps:**\n1. Navigate to the Azure Portal.\n2. Go to the Azure Monitor section.\n3. Set up a new activity log alert rule for the \"Create Policy Assignment\" event.\n4. Configure alert criteria, including conditions and actions.\n5. Test the alert to ensure proper functioning.\n6. Regularly review and update the alert configuration to adapt to evolving security and compliance requirements.\n\nBy adhering to these best practices, organizations can enhance their security posture, maintain compliance, and reduce the potential costs associated with non-compliance with this Azure control.\n"
  x-kaytu-usefulness-example:
  - "Below is an example instance of creating an Activity Log alert in Azure for the \"Create Policy Assignment\" event using Azure Policy.\n\njson\n{\n  \"$schema\": \"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#\",\n  \"contentVersion\": \"1.0.0.0\",\n  \"resources\": [\n    {\n      \"type\": \"Microsoft.Insights/activityLogAlerts\",\n      \"apiVersion\": \"2017-04-01\",\n      \"name\": \"policyAssignmentCreatedAlert\",\n      \"location\": \"global\",\n      \"properties\": {\n        \"description\": \"Alert for Create Policy Assignment event\",\n        \"condition\": {\n          \"allOf\": [\n            {\n              \"field\": \"category\",\n              \"equals\": \"Policy\"\n            },\n            {\n              \"field\": \"operationName\",\n              \"equals\": \"Microsoft.Authorization/policyAssignments/write\"\n            }\n          ]\n        },\n        \"actions\": {\n          \"actionGroups\": [\n            {\n              \"actionGroupId\": \"/subscriptions/{subscription-id}/resourceGroups/{resource-group}/providers/Microsoft.Insights/actionGroups/{action-group-id}\"\n            }\n          ]\n        }\n      }\n    }\n  ]\n}\nIn this example:\n\nThe resource type is set to \"Microsoft.Insights/activityLogAlerts\".\nThe condition is specified to trigger the alert when the activity log event category is \"Policy\" and the operation name is \"Microsoft.Authorization/policyAssignments/write\" (indicating the creation of a policy assignment).\nThe alert is configured to trigger an action group, which can be set up to notify relevant stakeholders or take specific actions in response to the alert.\nMake sure to replace placeholders such as {subscription-id}, {resource-group}, and {action-group-id} with your actual subscription ID, resource group, and action group ID, respectively. Additionally, you may need to adjust other properties based on your specific requirements and Azure environment configuration."
Title: Ensure that Activity Log Alert exists for Create Policy Assignment
