{
  "ID": "azure_monitor_log_alert_create_update_security_solution",
  "Title": "Ensure that Activity Log Alert exists for Create or Update Security Solution",
  "Description": "Create an activity log alert for the Create or Update Security Solution event.",
  "Query": {
    "Connector": "Azure",
    "Engine": "odysseus-v0.0.1",
    "ListOfTables": [
      "azure_log_alert",
      "azure_subscription"
    ],
    "PrimaryTable": "azure_log_alert",
    "QueryToExecute": "with alert_rule as (\n  select\n    alert.id as alert_id,\n    alert.name as alert_name,\n    alert.enabled,\n    alert.location,\n    alert.subscription_id\n  from\n    azure_log_alert as alert,\n    jsonb_array_elements_text(scopes) as sc\n  where\n    alert.location = 'Global'\n    and alert.enabled\n    and sc = '/subscriptions/' || alert.subscription_id\n    and (\n      (\n        alert.condition -\u003e 'allOf' @\u003e '[{\"equals\":\"Security\",\"field\":\"category\"}]'\n        and alert.condition -\u003e 'allOf' @\u003e '[{\"field\": \"resourceType\", \"equals\": \"microsoft.security/securitysolutions\"}]'\n        and alert.condition -\u003e 'allOf' @\u003e '[{\"field\": \"operationName\", \"equals\": \"Microsoft.Security/securitySolutions/write\"}]'\n      )\n      or\n      (\n        alert.condition -\u003e 'allOf' @\u003e '[{\"equals\":\"Security\",\"field\":\"category\"}]'\n        and alert.condition -\u003e 'allOf' @\u003e '[{\"field\": \"resourceType\", \"equals\": \"microsoft.security/securitysolutions\"}]'\n        and jsonb_array_length(alert.condition -\u003e 'allOf') = 2\n      )\n    )\n  limit 1\n)\nselect\n  sub.subscription_id as resource,\n  sub.kaytu_account_id as kaytu_account_id,\n  sub.kaytu_resource_id as kaytu_resource_id,\n  case\n    when count(a.subscription_id) \u003e 0 then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when count(a.subscription_id) \u003e 0 then 'Activity log alert exists for create or update Security Solution event.'\n    else 'Activity log alert does not exists for create or update Security Solution event.'\n  end as reason\n  \n  , sub.display_name as subscription\nfrom\n  azure_subscription sub\n  left join alert_rule a on sub.subscription_id = a.subscription_id\ngroup by\n  sub.kaytu_account_id,\n  sub.kaytu_resource_id,\n  sub._ctx,\n  sub.subscription_id,\n  sub.display_name;\n"
  },
  "DocumentURI": "",
  "ManualVerification": false,
  "Severity": "medium",
  "Tags": {
    "category": [
      "Compliance"
    ],
    "cis": [
      "true"
    ],
    "cis_item_id": [
      "5.2.7"
    ],
    "cis_level": [
      "1"
    ],
    "cis_section_id": [
      "5.2"
    ],
    "cis_type": [
      "automated"
    ],
    "cis_version": [
      "v1.3.0"
    ],
    "plugin": [
      "azure"
    ],
    "service": [
      "Azure/Monitor"
    ],
    "x-kaytu-explanation": [
      "## Azure Activity Log Alert for \"Create or Update Security Solution\" Event\n\nTo enhance your Azure security monitoring, you can set up an activity log alert specifically for the \"Create or Update Security Solution\" event. This alert will notify you when any such event occurs within your Azure environment.\n\n### Steps to Create the Activity Log Alert:\n\n1. **Navigate to Azure Portal:**\n   - Open your web browser and go to the [Azure Portal](https://portal.azure.com/).\n\n2. **Access Activity Log:**\n   - In the left navigation pane, select the \"Monitor\" tab, and then click on \"Activity log.\"\n\n3. **Filter by Event Type:**\n   - Use the event type filter to focus on \"Security + Audit\" events.\n\n4. **Select the Event:**\n   - Locate the \"Create or Update Security Solution\" event in the list.\n\n5. **Set up Alert Rule:**\n   - Click on the \"New alert rule\" button.\n\n6. **Define Alert Criteria:**\n   - Fill in the necessary information such as:\n     - **Name:** Give a meaningful name to your alert rule.\n     - **Description:** Provide a brief description for reference.\n     - **Resource Group:** Choose the appropriate resource group for scoping.\n     - **Condition:** Define the condition based on the \"Create or Update Security Solution\" event.\n     - **Actions:** Specify the actions to be taken when the alert is triggered (e.g., email notification, webhook).\n\n7. **Configure Alert Severity and Threshold:**\n   - Set the severity level and threshold for the alert to ensure it aligns with your monitoring priorities.\n\n8. **Review and Create:**\n   - Review your settings and click on \"Create\" to finalize the alert rule.\n\n### Conclusion:\n\nBy following these steps, you have successfully created an activity log alert in Azure that specifically monitors the \"Create or Update Security Solution\" event. This proactive approach to monitoring helps you stay informed about critical security-related changes within your Azure environment.\n"
    ],
    "x-kaytu-noncompliance-cost": [
      "# Control: Create Activity Log Alert for Create or Update Security Solution Event\n\n## Cost of Non-Compliance\n\n### 1. **Security Risks:**\n   - Without an alert for security solution changes, unauthorized modifications may go unnoticed.\n   - Lack of timely alerts increases the risk of security breaches and potential data breaches.\n\n### 2. **Compliance Violations:**\n   - Non-compliance may result in violations of regulatory requirements (e.g., GDPR, HIPAA) for monitoring and auditing security-related activities.\n\n### 3. **Delayed Incident Response:**\n   - Failure to create an activity log alert may lead to delayed incident response, allowing malicious activities to persist undetected.\n\n### 4. **Reputational Damage:**\n   - Security incidents, when not promptly addressed, can damage the organization's reputation and erode customer trust.\n\n### 5. **Legal Consequences:**\n   - Non-compliance with security controls may result in legal consequences, fines, or penalties from regulatory bodies.\n\n## Recommendations for Compliance\n\nTo ensure compliance with this control, follow these recommendations:\n\n1. **Configure Activity Log Alerts:**\n   - Set up Azure Activity Log alerts specifically for the \"Create or Update Security Solution\" event.\n\n2. **Define Alert Thresholds:**\n   - Establish appropriate alert thresholds to filter out noise and focus on significant security solution changes.\n\n3. **Incident Response Plan:**\n   - Develop and maintain an incident response plan to promptly address any alerts triggered by security solution changes.\n\n4. **Regular Audits:**\n   - Conduct regular audits to ensure that activity log alerts are functioning as expected and are aligned with the organization's security policies.\n\n## Summary\n\nCreating an activity log alert for the \"Create or Update Security Solution\" event is critical for maintaining a secure Azure environment. Non-compliance can lead to security risks, compliance violations, delayed incident response, reputational damage, and legal consequences. Implementing the recommended measures will help mitigate these risks and ensure a proactive and effective approach to security monitoring and incident response.\n"
    ],
    "x-kaytu-usefulness-example": [
      "Below is an example instance of creating an Activity Log alert for the \"Create or Update Security Solution\" event using Azure Resource Manager (ARM) template:\n\njson\n{\n  \"$schema\": \"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#\",\n  \"contentVersion\": \"1.0.0.0\",\n  \"resources\": [\n    {\n      \"type\": \"Microsoft.Insights/activityLogAlerts\",\n      \"apiVersion\": \"2017-04-01\",\n      \"name\": \"SecuritySolutionCreationUpdateAlert\",\n      \"location\": \"global\",\n      \"properties\": {\n        \"displayName\": \"Security Solution Creation or Update Alert\",\n        \"description\": \"Alert triggered for the Create or Update Security Solution event\",\n        \"enabled\": true,\n        \"scopes\": [\"/subscriptions/{subscriptionId}\"],\n        \"condition\": {\n          \"allOf\": [\n            {\n              \"field\": \"category\",\n              \"equals\": \"Administrative\"\n            },\n            {\n              \"field\": \"operationName\",\n              \"equals\": \"Microsoft.Security/securitySolutions/write\"\n            },\n            {\n              \"field\": \"status\",\n              \"equals\": \"Succeeded\"\n            }\n          ]\n        },\n        \"actions\": {\n          \"actionGroups\": [\n            {\n              \"actionGroupId\": \"/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Insights/actionGroups/{actionGroupName}\"\n            }\n          ]\n        }\n      }\n    }\n  ]\n}\nIn this ARM template:\n\nReplace {subscriptionId} with your actual subscription ID.\nReplace {resourceGroupName} with the resource group name where you want to create the alert.\nReplace {actionGroupName} with the name of the action group that will be triggered when the alert fires.\nThis template defines an Activity Log alert named \"SecuritySolutionCreationUpdateAlert\" that is triggered when a successful creation or update of a security solution occurs. The alert is configured to send notifications or perform specified actions through an action group."
    ]
  },
  "Managed": true
}