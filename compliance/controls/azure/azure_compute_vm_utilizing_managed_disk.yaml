Description: Migrate BLOB based VHD's to Managed Disks on Virtual Machines to exploit the default features of this configuration.
DocumentURI: ""
ID: azure_compute_vm_utilizing_managed_disk
Managed: true
ManualVerification: false
Query:
  Connector: Azure
  Engine: odysseus-v0.0.1
  ListOfTables:
  - azure_compute_virtual_machine
  - azure_subscription
  PrimaryTable: azure_compute_virtual_machine
  QueryToExecute: |
    select
      vm.id as resource,
      vm.kaytu_account_id as kaytu_account_id,
      vm.kaytu_resource_id as kaytu_resource_id,
      case
        when managed_disk_id is null then 'alarm'
        else 'ok'
      end as status,
      case
        when managed_disk_id is null then vm.name || ' VM not utilizing managed disks.'
        else vm.name || ' VM utilizing managed disks.'
      end as reason
      
      , vm.resource_group as resource_group
      , sub.display_name as subscription
    from
      azure_compute_virtual_machine as vm,
      azure_subscription as sub
    where
      sub.subscription_id = vm.subscription_id;
Severity: medium
Tags:
  category:
  - Compliance
  cis:
  - "true"
  cis_item_id:
  - "7.1"
  cis_level:
  - "1"
  cis_section_id:
  - "7"
  cis_type:
  - manual
  cis_version:
  - v1.3.0
  plugin:
  - azure
  service:
  - Azure/Compute
  x-kaytu-explanation:
  - "Azure Managed Disks simplify disk management for Azure Infrastructure as a Service (IaaS) virtual machines (VMs) by managing the storage accounts associated with the VM disks. You only have to specify the size of the disk, and Azure creates and manages the disk for you.\n\nFollowing is the code to migrate Blob-based VHDs to Managed Disks:\n\n```markup\n# Login into your Azure account\naz login\n\n# Set your subscription\naz account set --subscription [subscription-id]\n\n# Stop the VM before migration\naz vm deallocate --resource-group [myResourceGroup] --name [myVM]\n\n# Migrate to Managed Disks\naz vm convert --resource-group [myResourceGroup] --name [myVM]\n\n# Start the VM after migration\naz vm start --resource-group [myResourceGroup] --name [myVM]\n```\n\nIn the above code, replace `[subscription-id]`, `[myResourceGroup]`, and `[myVM]` with your subscription ID, the name of the resource group and the name of the virtual machine that you wish to migrate.\n\nIf the VM is in an availability set, then all the VMs in the set need to be stopped and converted together. Managed Disks handle the storage behind the scenes for you. They offer you several advantages like high-availability, manageability, scalability, improved reliability for high-availability and increased security."
  x-kaytu-noncompliance-cost:
  - |-
    Non-compliance with migrating BLOB based VHD's to Managed Disks on Azure Virtual Machines might result in the following costs:

    1. **Performance Issues:** Managed Disks can provide up to 20x more IOPS and better throughput compared to traditional Blob storage. Not exploiting this feature could mean lower performance for your applications hosted on the VMs.

    2. **Increased Management Overhead:** With Managed Disks, you don't have to worry about Storage Account limits. This feature simplifies the management process. Failing to migrate could result in higher management overhead to manage Storage Accounts and handle their limits.

    3. **Increased Costs:** Managed Disks come with predictable performance and cost. If you use unmanaged disks, you could see variable performance and cost depending on the storage accounts' usage where your disks are located.

    4. **Reduced Scalability:** Managed Disks allow you to create up to 50,000 VM disks of a type in a subscription, which makes it much easier to create thousands of VMs in a single subscription. Without migration, you might struggle with the scalability of your applications.

    5. **Lack of Integration Features:** Managed Disks are integrated with Azure Backup and Azure Site Recovery. By not migrating, you would not take advantage of seamless backup and disaster recovery solutions.

    6. **Lack of Security:** Managed Disks come with Azure Disk Encryption, integration with Azure Role-Based Access Control (RBAC) and Azure Private Link. Failure to migrate could mean you are missing out on these additional security features, placing your data at risk. 

    Overall, non-compliance with this Azure control could lead to potentially higher costs both in performance and management time, less scalability for your applications, lack of integrated features like Backup and Site Recovery, and weaker security.
  x-kaytu-usefulness-example:
  - |-
    For instance, consider a scenario where a software development company is using cloud-based virtual machines for their different projects. These virtual machines store and serve a large amount of data which is stored in BLOB-based VHD's (Virtual Hard Disk). 

    The company can use the Azure Control to migrate these BLOB-based VHD's to Managed Disks. With managed disks, they can take advantage of the automatic handling of storage, so they donâ€™t need to worry about creating and managing storage accounts. 

    Moreover, the managed disks are designed for 99.999% availability with an enterprise-grade management layer. The improved security features such as Azure Disk Encryption, Azure Backup, Azure Site Recovery, and Azure Monitor can also be exploited. 

    This example demonstrates the usefulness of Azure Control's capability to migrate BLOB-based VHD's to Managed Disks on Virtual Machines.
Title: Ensure Virtual Machines are utilizing Managed Disks
