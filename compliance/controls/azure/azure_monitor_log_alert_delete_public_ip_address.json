{
  "ID": "azure_monitor_log_alert_delete_public_ip_address",
  "Title": "Ensure that Activity Log Alert exists for Delete Public IP Address rule",
  "Description": "Create an activity log alert for the Delete Public IP Address rule.",
  "Query": {
    "Connector": "Azure",
    "Engine": "odysseus-v0.0.1",
    "ListOfTables": [
      "azure_log_alert",
      "azure_subscription"
    ],
    "PrimaryTable": "azure_log_alert",
    "QueryToExecute": "with alert_rule as(\n  select\n    alert.id as alert_id,\n    alert.name as alert_name,\n    alert.enabled,\n    alert.location,\n    alert.subscription_id\n  from\n    azure_log_alert as alert,\n    jsonb_array_elements_text(scopes) as sc\n  where\n    alert.location = 'Global'\n    and alert.enabled\n    and sc = '/subscriptions/' || alert.subscription_id\n    and\n    (\n      ( alert.condition -\u003e 'allOf' @\u003e '[{\"equals\":\"Administrative\",\"field\":\"category\"}]'\n      and alert.condition -\u003e 'allOf' @\u003e '[{\"field\": \"resourceType\", \"equals\": \"microsoft.network/publicipaddresses\"}]'\n      and alert.condition -\u003e 'allOf' @\u003e '[{\"field\": \"operationName\", \"equals\": \"Microsoft.Network/publicIPAddresses/delete\"}]'\n      )\n      or\n      (\n        alert.condition -\u003e 'allOf' @\u003e '[{\"equals\":\"Administrative\",\"field\":\"category\"}]'\n        and alert.condition -\u003e 'allOf' @\u003e '[{\"field\": \"resourceType\", \"equals\": \"microsoft.network/publicipaddresses\"}]'\n        and jsonb_array_length(alert.condition -\u003e 'allOf') = 2\n      )\n    )\n    limit 1\n)\nselect\n  sub.subscription_id as resource,\n  sub.kaytu_account_id as kaytu_account_id,\n  sub.kaytu_resource_id as kaytu_resource_id,\n  case\n    when count(a.subscription_id) \u003e 0 then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when count(a.subscription_id) \u003e 0 then 'Activity Log Alert exists for Delete Public IP Address rule.'\n    else 'Activity Log Alert does not exists for Delete Public IP Address rule.'\n  end as reason\n  \n  , sub.display_name as subscription\nfrom\n  azure_subscription sub\n  left join alert_rule a on sub.subscription_id = a.subscription_id\ngroup by\n  sub.kaytu_account_id,\n  sub.kaytu_resource_id,\n  sub._ctx,\n  sub.subscription_id,\n  sub.display_name;\n"
  },
  "DocumentURI": "",
  "ManualVerification": false,
  "Severity": "medium",
  "Tags": {
    "category": [
      "Compliance"
    ],
    "cis": [
      "true"
    ],
    "cis_item_id": [
      "5.2.10"
    ],
    "cis_level": [
      "1"
    ],
    "cis_section_id": [
      "5"
    ],
    "cis_type": [
      "automated"
    ],
    "cis_version": [
      "v1.5.0"
    ],
    "plugin": [
      "azure"
    ],
    "service": [
      "Azure/Monitor"
    ],
    "x-kaytu-explanation": [
      "# Azure Activity Log Alert Setup\n\n## Objective\nCreate an activity log alert in Azure to monitor and receive notifications for the \"Delete Public IP Address\" rule.\n\n## Steps\n\n1. **Navigate to Azure Portal**\n    - Open your web browser and go to the [Azure Portal](https://portal.azure.com/).\n\n2. **Access Activity Log**\n    - In the left navigation pane, click on the \"Monitor\" tab.\n\n3. **Activity Log Section**\n    - Choose the \"Activity log\" option under the \"Monitoring\" section.\n\n4. **Filter by Operation**\n    - In the Activity log, locate the filter options.\n    - Set the filter to the desired time range and filter by the operation \"Delete Public IP Address.\"\n\n5. **Create Alert Rule**\n    - Click on the \"Alerts\" tab in the Activity log section.\n\n6. **New Alert Rule**\n    - Click on the \"New alert rule\" button.\n\n7. **Define Conditions**\n    - In the \"Condition\" section, set the conditions for the alert.\n        - **Resource Type**: Choose the appropriate resource type related to the Public IP Address.\n        - **Operation Name**: Select \"Delete Public IP Address.\"\n        - Adjust other conditions as needed.\n\n8. **Actions and Notifications**\n    - Configure the actions to be taken when the alert conditions are met.\n        - **Action Group**: Specify an existing action group or create a new one.\n        - **Notification**: Choose the notification method (e.g., email, SMS, webhook).\n\n9. **Alert Rule Details**\n    - Provide a meaningful name and description for the alert rule to facilitate easy identification.\n\n10. **Review and Create**\n    - Review the configured settings to ensure accuracy.\n    - Click \"Create\" to finalize the alert rule.\n\n11. **Verification**\n    - To verify the alert, perform a test operation that triggers the \"Delete Public IP Address\" rule.\n    - Confirm that the alert is generated and notifications are received as configured.\n\n12. **Monitoring**\n    - Monitor the alerts in the Azure Portal or through the specified notification channels regularly.\n\n## Conclusion\nBy following these steps, you have successfully set up an activity log alert in Azure to promptly detect and notify for any operations related to the deletion of Public IP Addresses.\n"
    ],
    "x-kaytu-noncompliance-cost": [
      "**Cost of Non-Compliance: Delete Public IP Address Rule**\n\n1. **Security Risks:**\n   - Failure to monitor and alert on the deletion of public IP addresses may lead to unauthorized changes in the network configuration.\n   - Increased vulnerability to security threats, as deleting a public IP address may impact network accessibility and expose resources to potential attacks.\n\n2. **Operational Disruptions:**\n   - Deletion of public IP addresses without proper tracking can cause operational disruptions, affecting the availability of services and applications relying on those addresses.\n   - Lack of awareness regarding these deletions may result in extended downtime and business interruptions.\n\n3. **Regulatory Compliance:**\n   - Non-compliance with activity logging and alerting for public IP address deletions may violate regulatory requirements and industry standards.\n   - Failure to demonstrate adherence to security best practices may lead to legal consequences and fines.\n\n4. **Financial Implications:**\n   - Uncontrolled deletion of public IP addresses may incur additional costs for remediation, recovery, and potential legal actions.\n   - Lack of timely alerts can result in delayed response, exacerbating the financial impact of security incidents.\n\n5. **Reputation Damage:**\n   - Security incidents stemming from non-compliance can damage the organization's reputation and erode customer trust.\n   - Negative publicity and loss of credibility may have long-term consequences for the business.\n\n**Recommendation:**\nImplementing an activity log alert for the \"Delete Public IP Address\" rule in Azure is crucial for proactive monitoring and response. This helps mitigate security risks, ensure operational stability, and maintain regulatory compliance.\n\n**Implementation Steps:**\n```powershell\n# Example PowerShell script to create an activity log alert for the Delete Public IP Address rule\nNew-AzActivityLogAlert -Name \"DeletePublicIPAddressAlert\" -Location \"East US\" -Operations \"Microsoft.Network/publicIPAddresses/delete\" -Status \"Active\" -WindowSize \"0:05:00\" -Severity \"Error\"\n"
    ],
    "x-kaytu-usefulness-example": [
      "Below is an example instance of creating an activity log alert for the \"Delete Public IP Address\" rule using Azure Resource Manager (ARM) template markup:\n\njson\n\n{\n  \"$schema\": \"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#\",\n  \"contentVersion\": \"1.0.0.0\",\n  \"resources\": [\n    {\n      \"type\": \"Microsoft.Insights/activityLogAlerts\",\n      \"apiVersion\": \"2017-04-01\",\n      \"name\": \"DeletePublicIPAddressAlert\",\n      \"location\": \"global\",\n      \"properties\": {\n        \"enabled\": true,\n        \"scopes\": [\"/subscriptions/{subscriptionId}\"],\n        \"condition\": {\n          \"allOf\": [\n            {\n              \"field\": \"category\",\n              \"equals\": \"Administrative\"\n            },\n            {\n              \"field\": \"resourceType\",\n              \"equals\": \"Microsoft.Network/publicIPAddresses\"\n            },\n            {\n              \"field\": \"operationName\",\n              \"equals\": \"Microsoft.Network/publicIPAddresses/delete\"\n            }\n          ]\n        },\n        \"actions\": {\n          \"actionGroups\": [\n            {\n              \"actionGroupId\": \"/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Insights/actionGroups/{actionGroupId}\"\n            }\n          ]\n        }\n      }\n    }\n  ]\n}\nPlease make sure to replace {subscriptionId}, {resourceGroupName}, and {actionGroupId} with your actual subscription ID, resource group name, and action group ID, respectively. This template creates an activity log alert that triggers when a public IP address is deleted in the specified subscription and resource group, sending notifications to the specified action group. Adjust the parameters and conditions according to your specific needs.\n\n\n\n\n\n\n"
    ]
  },
  "Managed": true
}