Description: Restricting default network access helps to provide a new layer of security, since storage accounts accept connections from clients on any network. To limit access to selected networks, the default action must be changed.
DocumentURI: ""
ID: azure_storage_account_default_network_access_rule_denied
Managed: true
ManualVerification: false
Query:
  Connector: Azure
  Engine: odysseus-v0.0.1
  ListOfTables:
  - azure_storage_account
  - azure_subscription
  PrimaryTable: azure_storage_account
  QueryToExecute: |
    select
      sa.id as resource,
      sa.kaytu_account_id as kaytu_account_id,
      sa.kaytu_resource_id as kaytu_resource_id,
      case
        when sa.network_rule_default_action = 'Allow' then 'alarm'
        else 'ok'
      end as status,
      case
        when sa.network_rule_default_action = 'Allow' then name || ' allows traffic from all networks.'
        else name || ' allows traffic from specific networks.'
      end as reason
      
      , sa.resource_group as resource_group
      , sub.display_name as subscription
    from
      azure_storage_account sa,
      azure_subscription sub
    where
      sub.subscription_id = sa.subscription_id;
Severity: high
Tags:
  category:
  - Compliance
  cis:
  - "true"
  cis_item_id:
  - "3.6"
  cis_level:
  - "2"
  cis_section_id:
  - "3"
  cis_type:
  - automated
  cis_version:
  - v1.3.0
  plugin:
  - azure
  service:
  - Azure/Storage
  x-kaytu-explanation:
  - |-
    Azure Storage Service supports an access control feature called "firewall and virtual networks". This feature gives you the ability to grant access to data in your storage account by enforcing network controls that reduce potential attack vectors. 

    When you restrict the networks that can access your storage account, the default action is to "deny". Only the networks specified in the firewall rules are given access. Here's how you can do that in the `markup format`.

    ```html
    <StorageServices>
      <StorageServiceProperties>
        <DefaultNetworkAccess>Deny</DefaultNetworkAccess>
        <IPRules>
          <IPRule>
            <Action>Allow</Action>
            <IPAddressOrRange>11.22.33.44</IPAddressOrRange>
          </IPRule>
        </IPRules>
        <VirtualNetworkRules>
          <VirtualNetworkRule>
            <Action>Allow</Action>
            <State>state</State>
            <VirtualNetworkResourceId>/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Network/virtualNetworks/{vnetName}</VirtualNetworkResourceId>
          </VirtualNetworkRule>
        </VirtualNetworkRules>
      </StorageServiceProperties>
    </StorageServices>
    ```

    In the above example, only the IP address `11.22.33.44` and the virtual network specified by the resource id have been given access to the storage account while the rest of the requests will be denied by default.

    This feature enables you to secure your data by ensuring that only requests from allowed networks, as specified by the IP address ranges or virtual network rules, will be accepted. Other requests will be denied. This includes both new requests and existing persistent connections.
  x-kaytu-noncompliance-cost:
  - "The cost of non-compliance to the Azure Control of restricting default network access can be significant. It includes the following potential threats and monetary implications:\n\n1. **Security Breaches**: Without compliance, your storage accounts may be accessed by unauthorized or malicious actors, leading to potential data leaks or breaches. The cost of a data breach can be severe, potentially running into millions of dollars depending on the size and sensitivity of the data.\n\n2. **Regulatory Penalties**: If your organization must adhere to certain industry regulations (like GDPR, HIPAA, CCPA, etc.) and those regulations include data security provisions, non-compliance with this Azure Control could lead to financial penalties.\n\n3. **Loss of Trust**: Non-compliance to this Azure Control could lead to a loss of customer trust if a data breach occurs. This can impact an organization's reputation, customer base, and eventually bottom-line income.\n\n4. **Downtime Cost**: In case of a breach, a considerable amount of time and resources might have to be diverted to contain the situation and mitigate the impact, leading to opportunity costs.\n\n5. **Incident Recovery Cost**: There could be significant recovery costs involved, including cybersecurity enhancement, PR efforts, regulatory communication, and litigation.\n\nTherefore, non-compliance to restricting default network access can cause a hefty price. Preventing breaches is not just about securing data but also essential to avoid financial and reputational damage."
  x-kaytu-usefulness-example:
  - |-
    For instance, consider a scenario where a company utilizes Azure Storage to store their crucial business data. This could include customer details, financial transactions, reports, and so forth. The data stored could be sensitive and should be strictly protected from unauthorized access or network attacks such as DDOS. 

    Using Azure default network access restriction feature, the company can limit and control the data access to only selected or certain trusted networks. This could be their internal networks across different branches or certain trusted client networks. They can modify the default action and deny access from all networks by default, hence by only permitting the trusted ones to connect to their storage accounts.

    This adds an extra layer of data security, preventing potential data breaches and protecting the business from potential threats or attacks over the internet. It ensures that their storage accounts are not publicly accessible, thereby keeping their business data safe and secure.

    ```markup
    resource "azurerm_storage_account_network_rules" "example" {
      resource_group_name  = azurerm_resource_group.example.name
      storage_account_name = azurerm_storage_account.example.name
      
      default_action             = "Deny"
      bypass                     = ["None"]
      ip_rules                   = ["110.0.0.23"]
      virtual_network_subnet_ids = [azurerm_subnet.example.id]
    }
    ```

    In the above `Terraform` example, the `default_action` is set to `"Deny"`, meaning that no network will be allowed to access the storage account by default. However, the `ip_rules` and `virtual_network_subnet_ids` properties specifies the trusted networks which will be granted access to the account.
Title: Ensure default network access rule for Storage Accounts is set to deny
