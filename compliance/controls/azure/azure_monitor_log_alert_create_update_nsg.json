{
  "ID": "azure_monitor_log_alert_create_update_nsg",
  "Title": "Ensure that Activity Log Alert exists for Create or Update Network Security Group",
  "Description": "Create an Activity Log Alert for the \"Create\" or \"Update Network Security Group\" event.",
  "Query": {
    "Connector": "Azure",
    "Engine": "odysseus-v0.0.1",
    "ListOfTables": [
      "azure_log_alert",
      "azure_subscription"
    ],
    "PrimaryTable": "azure_log_alert",
    "QueryToExecute": "with alert_rule as (\n  select\n    alert.id as alert_id,\n    alert.name as alert_name,\n    alert.enabled,\n    alert.location,\n    alert.subscription_id\n  from\n    azure_log_alert as alert,\n    jsonb_array_elements_text(scopes) as sc\n  where\n    alert.location = 'Global'\n    and alert.enabled\n    and sc = '/subscriptions/' || alert.subscription_id\n    and (\n      (\n        alert.condition -\u003e 'allOf' @\u003e '[{\"equals\":\"Administrative\",\"field\":\"category\"}]'\n        and alert.condition -\u003e 'allOf' @\u003e '[{\"field\": \"resourceType\", \"equals\": \"microsoft.network/networksecuritygroups\"}]'\n        and alert.condition -\u003e 'allOf' @\u003e '[{\"field\": \"operationName\", \"equals\": \"Microsoft.Network/networkSecurityGroups/write\"}]'\n      )\n      or\n      (\n        alert.condition -\u003e 'allOf' @\u003e '[{\"equals\":\"Administrative\",\"field\":\"category\"}]'\n        and alert.condition -\u003e 'allOf' @\u003e '[{\"field\": \"resourceType\", \"equals\": \"microsoft.network/networksecuritygroups\"}]'\n        and jsonb_array_length(alert.condition -\u003e 'allOf') = 2\n      )\n    )\n  limit 1\n)\nselect\n  sub.subscription_id as resource,\n  sub.kaytu_account_id as kaytu_account_id,\n  sub.kaytu_resource_id as kaytu_resource_id,\n  case\n    when count(a.subscription_id) \u003e 0 then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when count(a.subscription_id) \u003e 0 then 'Activity log alert exists for create or update Network Security Group event.'\n    else 'Activity log alert does not exists for create or update Network Security Group event.'\n  end as reason\n  \n  , sub.display_name as subscription\nfrom\n  azure_subscription sub\n  left join alert_rule a on sub.subscription_id = a.subscription_id\ngroup by\n  sub._ctx,\n  sub.subscription_id,\n  sub.kaytu_account_id,\n  sub.kaytu_resource_id,\n  sub.display_name;\n"
  },
  "DocumentURI": "",
  "ManualVerification": false,
  "Severity": "medium",
  "Tags": {
    "category": [
      "Compliance"
    ],
    "cis": [
      "true"
    ],
    "cis_item_id": [
      "5.2.3"
    ],
    "cis_level": [
      "1"
    ],
    "cis_section_id": [
      "5.2"
    ],
    "cis_type": [
      "automated"
    ],
    "cis_version": [
      "v1.3.0"
    ],
    "plugin": [
      "azure"
    ],
    "service": [
      "Azure/Monitor"
    ],
    "x-kaytu-explanation": [
      "# Azure Control Description\n\n## Control Name\nEnsure Activity Log Alert for Create or Update Network Security Group Exists\n\n## Control Overview\nThis Azure Control is designed to verify the existence of an Activity Log Alert specifically configured to monitor the creation or update events related to Network Security Groups (NSGs). Monitoring these activities is crucial for maintaining the security posture of Azure resources.\n\n## Control Criteria\nTo meet this control, there must be a defined Activity Log Alert with the following characteristics:\n- **Alert Type:** Activity Log\n- **Operation Name:** Microsoft.Network/networkSecurityGroups/write\n- **Status:** Enabled\n- **Severity Level:** Warning or higher\n- **Actions:** Configured to notify relevant stakeholders or trigger automated responses\n\n## Rationale\nNetwork Security Groups play a vital role in controlling inbound and outbound traffic to Azure resources. Monitoring the creation or update of NSGs helps in identifying potential security misconfigurations, unauthorized changes, or malicious activities. The Activity Log Alert ensures that relevant stakeholders are promptly notified or automated actions are taken when such events occur.\n\n## Remediation\nIf the Activity Log Alert for NSG creation or update is not found or does not meet the specified criteria, the following remediation steps should be taken:\n1. Create a new Activity Log Alert with the specified criteria.\n2. Ensure that the alert is enabled and configured to trigger appropriate actions.\n3. Regularly review and update the alert configuration to adapt to changing security requirements.\n\n## References\n- [Azure Activity Log Alerts](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/alerts-log)\n\n"
    ],
    "x-kaytu-noncompliance-cost": [
      "# Cost of Non-Compliance: Activity Log Alert for \"Create\" or \"Update Network Security Group\" Event\n\n## 1. **Security Risks**\n   - Without the alert, unauthorized changes to Network Security Groups (NSGs) may go unnoticed.\n   - Increased risk of security breaches or policy violations.\n\n## 2. **Operational Impact**\n   - Lack of visibility into NSG changes can lead to difficulties in troubleshooting network issues.\n   - Increased mean time to detect and resolve network-related issues.\n\n## 3. **Compliance Violations**\n   - Non-compliance with regulatory requirements related to monitoring and auditing changes.\n   - Potential legal and financial consequences due to regulatory fines.\n\n## 4. **Reputational Damage**\n   - Incidents involving unauthorized NSG changes may harm the organization's reputation.\n   - Loss of trust from customers, partners, and stakeholders.\n\n## 5. **Financial Implications**\n   - Costs associated with resolving security incidents or breaches.\n   - Potential financial penalties for non-compliance with industry regulations.\n\n## 6. **Resource Wastage**\n   - Inefficient use of resources in managing and mitigating the aftermath of security incidents.\n   - Allocation of additional resources for incident response and recovery.\n\n## 7. **Long-Term Consequences**\n   - Cumulative impact on the organization's long-term security posture.\n   - Difficulty in regaining compliance and rebuilding trust.\n\n## 8. **Mitigation Costs**\n   - Implementing the Activity Log Alert post-incident may incur additional costs.\n   - Reactive measures may be more resource-intensive than proactive compliance.\n\n## Conclusion\n   - Ensuring compliance with the Azure Control for Activity Log Alerts is essential.\n   - Proactive monitoring and alerting contribute to a more secure and resilient Azure environment.\n\n"
    ],
    "x-kaytu-usefulness-example": [
      "below is an example of how you can use Azure Resource Manager (ARM) template to create an Activity Log Alert for the \"Create\" or \"Update Network Security Group\" event:\n\njson\n{\n  \"$schema\": \"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#\",\n  \"contentVersion\": \"1.0.0.0\",\n  \"resources\": [\n    {\n      \"type\": \"Microsoft.Insights/activityLogAlerts\",\n      \"apiVersion\": \"2017-04-01\",\n      \"name\": \"exampleActivityLogAlert\",\n      \"location\": \"global\",\n      \"properties\": {\n        \"displayName\": \"Network Security Group Creation or Update Alert\",\n        \"description\": \"Alert for Network Security Group creation or update events\",\n        \"enabled\": true,\n        \"scopes\": [\"/subscriptions/{subscriptionId}\"],\n        \"condition\": {\n          \"allOf\": [\n            {\n              \"field\": \"category\",\n              \"equals\": \"Administrative\"\n            },\n            {\n              \"field\": \"operationName\",\n              \"in\": [\n                \"Microsoft.Network/networkSecurityGroups/write\",\n                \"Microsoft.Network/networkSecurityGroups/delete\"\n              ]\n            },\n            {\n              \"field\": \"status\",\n              \"in\": [\"Succeeded\"]\n            }\n          ]\n        },\n        \"actions\": {\n          \"actionGroups\": [\n            {\n              \"actionGroupId\": \"/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/microsoft.insights/actionGroups/{actionGroupId}\"\n            }\n          ]\n        }\n      }\n    }\n  ]\n}\nIn this example:\n\nReplace {subscriptionId} with your actual subscription ID.\nReplace {resourceGroupName} with the name of the resource group where you want to create the alert.\nReplace {actionGroupId} with the ID of the action group you want to associate with the alert.\nThis ARM template creates an Activity Log Alert that triggers when a \"Create\" or \"Update Network Security Group\" event occurs and the status is \"Succeeded.\" The alert is associated with an action group that you need to define separately. The action group could include actions like sending an email notification, triggering a webhook, etc."
    ]
  },
  "Managed": true
}