Description: This policy audits any Windows/Linux Virtual Machine Scale Sets if the
  Log Analytics extension is not installed.
ID: the_log_analytics_extension_should_be_installed_on_virtual_machine_scale_sets
Query:
  Connector: Azure
  Engine: odysseus-v0.0.1
  QueryToExecute: 'SELECT name, type, provisioning_state, extensions->''publisher''
    AS publisher, extensions->''settings''->''workspaceId'' AS workspace_id, extensions->''type''
    AS extension_type, extensions->''provisioningState'' AS provisioning_state

    FROM azure_compute_virtual_machine_scale_set

    WHERE type = ''Microsoft.Compute/virtualMachineScaleSets''

    AND (extensions->''publisher'' = ''Microsoft.EnterpriseCloud.Monitoring'' OR kaytu_description->''extensions''->''publisher''
    @> ''[{"VirtualMachineScaleSetExtension": [{"Publisher": "Microsoft.EnterpriseCloud.Monitoring"}]}]'')

    AND (extensions->''type'' IN (''MicrosoftMonitoringAgent'', ''OmsAgentForLinux'')
    OR kaytu_description->''extensions''->''type'' @> ''[{"VirtualMachineScaleSetExtension":
    [{"Type": "MicrosoftMonitoringAgent"}, {"Type": "OmsAgentForLinux"}]}]'')

    AND (extensions->''provisioningState'' = ''Succeeded'' OR kaytu_description->''extensions''->''provisioningState''
    @> ''[{"VirtualMachineScaleSetExtension": [{"Properties": {"ProvisioningState":
    "Succeeded"}}]}]'')

    AND (extensions->''settings''->''workspaceId'' IS NOT NULL OR kaytu_description->''extensions''->''settings''->''workspaceId''
    @> ''[{"VirtualMachineScaleSetExtension": [{"Properties": {"Settings": {"workspaceId":
    {"$exists": true}}}}]}]'')

    LIMIT 5;;

    '
Severity: ''
Title: The Log Analytics extension should be installed on Virtual Machine Scale Sets
