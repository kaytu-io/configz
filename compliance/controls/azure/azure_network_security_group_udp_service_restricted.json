{
  "ID": "azure_network_security_group_udp_service_restricted",
  "Title": "Ensure that UDP Services are restricted from the Internet",
  "Description": "Disable Internet exposed UDP ports on network security groups.",
  "Query": {
    "Connector": "Azure",
    "Engine": "odysseus-v0.0.1",
    "ListOfTables": [
      "azure_network_security_group",
      "azure_subscription"
    ],
    "PrimaryTable": "azure_network_security_group",
    "QueryToExecute": "with network_sg as (\n  select\n    distinct name sg_name\n  from\n    azure_network_security_group nsg,\n    jsonb_array_elements(security_rules) sg,\n    jsonb_array_elements_text(sg -\u003e 'properties' -\u003e 'destinationPortRanges' || (sg -\u003e 'properties' -\u003e 'destinationPortRange') :: jsonb) dport,\n    jsonb_array_elements_text(sg -\u003e 'properties' -\u003e 'sourceAddressPrefixes' || (sg -\u003e 'properties' -\u003e 'sourceAddressPrefix') :: jsonb) sip\n  where\n    sg -\u003e 'properties' -\u003e\u003e 'access' = 'Allow'\n    and sg -\u003e 'properties' -\u003e\u003e 'direction' = 'Inbound'\n    and sg -\u003e 'properties' -\u003e\u003e 'protocol' = 'UDP'\n    and sip in ('*', '0.0.0.0', '0.0.0.0/0', 'Internet', 'any', '\u003cnw\u003e/0', '/0')\n    and (\n      dport = '*'\n      or (\n        dport like '%-%'\n        and (\n          53 between split_part(dport, '-', 1) :: integer and split_part(dport, '-', 2) :: integer\n          or 123 between split_part(dport, '-', 1) :: integer and split_part(dport, '-', 2) :: integer\n          or 161 between split_part(dport, '-', 1) :: integer and split_part(dport, '-', 2) :: integer\n          or 389 between split_part(dport, '-', 1) :: integer and split_part(dport, '-', 2) :: integer\n          or 1900 between split_part(dport, '-', 1) :: integer and split_part(dport, '-', 2) :: integer\n        )\n      )\n    )\n)\nselect\n  sg.id resource,\n  sg.kaytu_account_id as kaytu_account_id,\n  sg.kaytu_resource_id as kaytu_resource_id,\n  case\n    when nsg.sg_name is null then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when nsg.sg_name is null\n      then sg.title || ' restricts UDP services from internet.'\n    else sg.title || ' allows UDP services from internet.'\n  end as reason\n  \n  , sg.resource_group as resource_group\n  , sub.display_name as subscription\nfrom\n  azure_network_security_group sg\n  left join network_sg nsg on nsg.sg_name = sg.name\n  join azure_subscription sub on sub.subscription_id = sg.subscription_id;\n"
  },
  "DocumentURI": "",
  "ManualVerification": false,
  "Severity": "high",
  "Tags": {
    "category": [
      "Compliance"
    ],
    "cis": [
      "true"
    ],
    "cis_item_id": [
      "6.6"
    ],
    "cis_level": [
      "1"
    ],
    "cis_section_id": [
      "6"
    ],
    "cis_type": [
      "automated"
    ],
    "cis_version": [
      "v1.3.0"
    ],
    "plugin": [
      "azure"
    ],
    "service": [
      "Azure/Network"
    ],
    "x-kaytu-explanation": [
      "# AWS Control: Disable Internet Exposed UDP Ports on Network Security Groups\n\nThis AWS Control ensures that User Datagram Protocol (UDP) ports are not unnecessarily exposed to the internet, reducing the risk of unauthorized access to your AWS resources.\n\n```markdown\n## Rationale\n\nUDP ports are used for services that need fast, connectionless communication. However, many of these services should not be directly exposed to the internet as they could be exploited by cyber criminals for malicious activities such as DoS attacks.\n\nBy disabling Internet-exposed UDP ports on network security groups, you decrease the attack surface, limiting the potential for exploitation.\n\n## Implementation \n\nIn the AWS Management Console:\n\n1. Navigate to the `VPC dashboard`.\n2. On the left navigation pane, click on `Security Groups`.\n3. Select the Security Group, go to `Inbound rules`.\n4. If any rules have `UDP` protocol and source `0.0.0.0/0` or `::/0`, they are exposed to the internet. \n\nTo remove them:\n\n1. Select the rule, click on `Actions`.\n2. Click `Delete inbound rule`.\n3. Confirm deletion in the dialog window. \n\n## Verification \n\nAfter making the changes, go back to `Security Groups`.\n\n1. Select the Security Group, go to `Inbound rules`.\n2. Ensure no rules have `UDP` protocol and source `0.0.0.0/0` or `::/0`.\n\n## Impact of Non-compliance\n\nFailure to comply with this control could potentially expose your AWS resources to threats such as DoS attacks, data breaches, unauthorized access to internal systems, and other security risks.\n```\nPlease note that your organization's specific processes for implementing and validating this control could vary."
    ],
    "x-kaytu-noncompliance-cost": [
      "Non-compliance with the AWS Control of disabling Internet-exposed UDP ports on network security groups can lead to several risks and costs:\n\n1. **Security Risk**: Potentially, the most critical cost of non-compliance is exposing your network to security risks. If UDP ports are left open, it could potentially allow unauthorized access to sensitive data by attackers, worms, viruses, and other types of malicious activities.\n\n2. **Loss of Data**: If an attack occurs due to open UDP ports, there is a significant risk of data loss, which can lead to substantial expenses and operational delays.\n\n3. **Financial Loss**: The financial loss can relate to fines or penalties by regulatory bodies for non-compliance. Also, there can be considerable direct costs involved in responding to and recovering from a security breach.\n\n4. **Reputation Damage**: Non-compliance could result in a security breach, which would negatively impact the reputation of the organization. This could also lead to loss of customer trust, resulting in potential loss of business.\n\n5. **Regulatory Compliance**: Depending on the nature of your business, you might be subject to various state, federal, and international regulations for data protection. Non-compliance could lead to penalties and could prohibit you from doing business until compliance is restored.\n\n6. **Operational Disruptions**: If a security breach occurs due to non-compliance, it could disrupt your operations leading to downtime and loss of productivity. \n\nHence, it is essential to comply with the AWS Control to disable Internet-exposed UDP ports on network security groups to avoid these potential costs."
    ],
    "x-kaytu-usefulness-example": [
      "For example, you operate a web-based business using Amazon Web Services. The nature of your business means you frequently handle sensitive customer data, such as credit card information, personal identification details, and login credentials. You have implemented stringent security measures, but you want an additional layer of protection to prevent data breaches. \n\nOne measure is disabling internet-exposed UDP ports on your network security groups. This prevents a possible DDoS (Distributed Denial of Service) attacks, which hackers often use UDP protocols because they do not require a three-way handshake like TCP, making them more effective for this type of malicious activity. \n\nBy disabling these ports, you add an extra barrier of protection for your network. It makes it significantly harder for hackers to infiltrate it and steal sensitive customer data. \n\n```\n### Scenario in Markup Format\n1. `Identify the Network Security Group` attached to the instance handling sensitive data.\n2. `Locate the Inbound Security Rules` associated with this group.\n3. `Search for any rules` linking Internet-exposed UDP ports.\n4. `Disable these rules` to prevent potential access from UDP traffic.\n5. `Fortify your security measure` with additional Amazon VPC features.\n```\nThis scenario provides a measure to strengthen your AWS security, ensuring your customer data remains confidential and trustworthy."
    ]
  },
  "Managed": true
}