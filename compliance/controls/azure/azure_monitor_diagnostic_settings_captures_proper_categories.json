{
  "ID": "azure_monitor_diagnostic_settings_captures_proper_categories",
  "Title": "Ensure Diagnostic Setting captures appropriate categories",
  "Description": "Enable Diagnostic settings for exporting activity logs. Diagnostic setting are available for each individual resources within a subscription. Settings should be configured for all appropriate resources for your environment.",
  "Query": {
    "Engine": "odysseus-v0.0.1",
    "QueryToExecute": "with enabled_settings as (\n  select\n    name,\n    id,\n    _ctx,\n    resource_group,\n    subscription_id,\n    count(*) filter (where l -\u003e\u003e 'enabled' = 'true'\n      and l -\u003e\u003e 'category' in ('Administrative', 'Security', 'Alert', 'Policy')\n    ) as valid_category_count,\n    string_agg(l -\u003e\u003e 'category', ', ') filter (where l -\u003e\u003e 'enabled' = 'true'\n      and l -\u003e\u003e 'category' in ('Administrative', 'Security', 'Alert', 'Policy')\n    ) as valid_categories\n  from\n    azure_diagnostic_setting,\n    jsonb_array_elements(logs) as l\n  group by\n    name,\n    id,\n    _ctx,\n    resource_group,\n    subscription_id\n)\nselect\n  sett.id as resource,\n  case\n    when valid_category_count = 4 then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when valid_category_count = 4\n      then name || ' logs enabled for required categories administrative, security, alert and policy.'\n    when valid_category_count \u003e 0\n      then sett.name || ' logs enabled for ' || valid_categories || ' categories.'\n      else sett.name || ' logs not enabled for categories administrative, security, alert and policy.'\n  end as reason\n  , sett.resource_group as resource_group\n  , sub.display_name as subscription\nfrom\n  enabled_settings sett,\n  azure_subscription sub\nwhere\n  sub.subscription_id = sett.subscription_id;\n",
    "Connector": "Azure",
    "PrimaryTable": "azure_diagnostic_setting",
    "ListOfTables": [
      "azure_diagnostic_setting",
      "azure_subscription"
    ]
  },
  "ManualVerification": false,
  "Severity": "",
  "Tags": {
    "category": [
      "Compliance"
    ],
    "cis": [
      "true"
    ],
    "cis_item_id": [
      "5.1.2"
    ],
    "cis_level": [
      "1"
    ],
    "cis_section_id": [
      "5.1"
    ],
    "cis_type": [
      "automated"
    ],
    "cis_version": [
      "v1.3.0"
    ],
    "plugin": [
      "azure"
    ],
    "service": [
      "Azure/Monitor"
    ]
  },
  "Managed": true
}