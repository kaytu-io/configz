{
  "ID": "azure_network_security_group_https_access_restricted",
  "Title": "Ensure that HTTP(S) access from the Internet is evaluated and restricted ",
  "Description": "Network security groups should be periodically evaluated for port misconfigurations. Where certain ports and protocols may be exposed to the Internet, they should be evaluated for necessity and restricted wherever they are not explicitly required and narrowly configured.",
  "Query": {
    "Engine": "odysseus-v0.0.1",
    "QueryToExecute": "with network_sg as (\n  select distinct\n    name sg_name\n  from\n    azure_network_security_group nsg,\n    jsonb_array_elements(security_rules) sg,\n    jsonb_array_elements_text(sg -\u003e 'properties' -\u003e 'destinationPortRanges' || (sg -\u003e 'properties' -\u003e 'destinationPortRange') :: jsonb) dport,\n    jsonb_array_elements_text(sg -\u003e 'properties' -\u003e 'sourceAddressPrefixes' || (sg -\u003e 'properties' -\u003e 'sourceAddressPrefix') :: jsonb) sip\n  where\n    sg -\u003e 'properties' -\u003e\u003e 'access' = 'Allow'\n    and sg -\u003e 'properties' -\u003e\u003e 'direction' = 'Inbound'\n    and sg -\u003e 'properties' -\u003e\u003e 'protocol' ilike 'TCP'\n    and sip in\n    (\n      '*',\n      '0.0.0.0',\n      '0.0.0.0/0',\n      'Internet',\n      'any',\n      '\u003cnw\u003e/0',\n      '/0'\n    )\n    and\n    (\n      dport in\n      (\n        '80',\n        '*'\n      )\n      or\n      (\n        dport like '%-%'\n        and split_part(dport, '-', 1) :: integer \u003c= 80\n        and split_part(dport, '-', 2) :: integer \u003e= 80\n      )\n    )\n)\nselect\n  sg.id resource,\n  case\n    when nsg.sg_name is null then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when nsg.sg_name is null then sg.title || ' restricts HTTPS access from internet.'\n    else sg.title || ' allows HTTPS access from internet.'\n  end as reason\n  \n  , sg.resource_group as resource_group\n  , sub.display_name as subscription\nfrom\n  azure_network_security_group sg\n  left join network_sg nsg on nsg.sg_name = sg.name\n  join azure_subscription sub on sub.subscription_id = sg.subscription_id;\n",
    "Connector": "Azure",
    "PrimaryTable": "azure_network_security_group",
    "ListOfTables": [
      "azure_network_security_group",
      "azure_subscription"
    ]
  },
  "ManualVerification": false,
  "Severity": "",
  "Tags": {
    "category": [
      "Compliance"
    ],
    "cis": [
      "true"
    ],
    "cis_item_id": [
      "6.4"
    ],
    "cis_level": [
      "1"
    ],
    "cis_section_id": [
      "6"
    ],
    "cis_type": [
      "automated"
    ],
    "cis_version": [
      "v1.5.0"
    ],
    "plugin": [
      "azure"
    ],
    "service": [
      "Azure/Network"
    ]
  },
  "Managed": true
}