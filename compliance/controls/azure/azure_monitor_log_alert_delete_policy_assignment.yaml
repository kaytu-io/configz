Description: Create an activity log alert for the Delete Policy Assignment event.
DocumentURI: ""
ID: azure_monitor_log_alert_delete_policy_assignment
Managed: true
ManualVerification: false
Query:
  Connector: Azure
  Engine: odysseus-v0.0.1
  ListOfTables:
  - azure_log_alert
  - azure_subscription
  PrimaryTable: azure_log_alert
  QueryToExecute: "with alert_rule as (\n  select\n    alert.id as alert_id,\n    alert.name as alert_name,\n    alert.enabled,\n    alert.location,\n    alert.subscription_id\n  from\n    azure_log_alert as alert,\n    jsonb_array_elements_text(scopes) as sc\n  where\n    alert.location = 'Global'\n    and alert.enabled\n    and sc = '/subscriptions/' || alert.subscription_id\n    and alert.condition -> 'allOf' @> '[{\"equals\":\"Administrative\",\"field\":\"category\"}]'\n    and alert.condition -> 'allOf' @> '[{\"field\": \"resourceType\", \"equals\": \"microsoft.authorization/policyassignments\"}]'\n    and alert.condition -> 'allOf' @> '[{\"field\": \"operationName\", \"equals\": \"Microsoft.Authorization/policyAssignments/delete\"}]'\n  limit 1\n)\nselect\n  sub.subscription_id as resource,\n  sub.kaytu_account_id as kaytu_account_id,\n  sub.kaytu_resource_id as kaytu_resource_id,\n  case\n    when count(a.subscription_id) > 0 then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when count(a.subscription_id) > 0 then 'Activity log alert exists for delete policy assignment event.'\n    else 'Activity log alert does not exists for delete policy assignment event.'\n  end as reason\n  \n  , sub.display_name as subscription\nfrom\n  azure_subscription sub\n  left join alert_rule a on sub.subscription_id = a.subscription_id\ngroup by\n  sub.kaytu_account_id,\n  sub.kaytu_resource_id,\n  sub._ctx,\n  sub.subscription_id,\n  sub.display_name;\n"
Severity: medium
Tags:
  category:
  - Compliance
  cis:
  - "true"
  cis_item_id:
  - 5.2.2
  cis_level:
  - "1"
  cis_section_id:
  - "5.2"
  cis_type:
  - automated
  cis_version:
  - v1.3.0
  plugin:
  - azure
  service:
  - Azure/Monitor
  x-kaytu-explanation:
  - "# Create Activity Log Alert for Delete Policy Assignment Event\n\nTo enhance monitoring and security in your Azure environment, you can create an activity log alert specifically for the \"Delete Policy Assignment\" event. This alert will notify you whenever a policy assignment is deleted, allowing you to promptly respond to such actions.\n\n## Steps:\n\n1. **Navigate to Azure Portal:**\n   Open the [Azure Portal](https://portal.azure.com/) and sign in to your Azure account.\n\n2. **Access Activity Log:**\n   - In the left navigation pane, click on **\"Monitor\"**.\n   - Under the \"Monitoring solutions\" section, select **\"Activity log\"**.\n\n3. **Create Activity Log Alert:**\n   - Click on the **\"Alerts\"** tab within the Activity log.\n   - Select **\"New alert rule\"** to initiate the alert creation process.\n\n4. **Configure Alert Rule:**\n   - Choose the **\"Select target\"** button and set the target scope to the desired subscription or resource group.\n   - In the \"Condition\" section, click on **\"Add condition\"** and choose **\"EventName\"**.\n   - Set the operator to **\"Equals\"** and the value to **\"Delete Policy Assignment\"**.\n\n5. **Define Actions:**\n   - Under the \"Actions\" section, click on **\"Add action group\"** to configure notification settings.\n   - Create or select an existing action group that includes the desired notification channels (e.g., email, SMS, webhook).\n\n6. **Set Alert Details:**\n   - Provide a meaningful **\"Alert rule name\"** and **\"Description\"** to identify the purpose of the alert.\n   - Choose the desired **\"Severity\"** for the alert.\n\n7. **Review and Create:**\n   - Review your alert configuration and click **\"Create alert rule\"** to save your settings.\n\nNow, your Azure environment is configured to trigger an alert whenever a policy assignment is deleted. This proactive approach to monitoring helps you maintain control and respond promptly to critical events within your Azure resources.\n"
  x-kaytu-noncompliance-cost:
  - |-
    The cost of non-compliance with the Azure Control "Create an activity log alert for the Delete Policy Assignment event" can be significant in terms of security, governance, and compliance. Failure to implement this control may lead to various risks and consequences, including:

    Security Breaches:

    Without an alert for the Delete Policy Assignment event, unauthorized or accidental deletions of policy assignments may go unnoticed.
    Lack of timely detection can result in security breaches, as malicious actors or misconfigured processes may exploit vulnerabilities.
    Policy Violations:

    Non-compliance may lead to policy violations, as the organization may have specific policies in place to control and monitor changes to policy assignments.
    Failure to enforce these policies can result in a deviation from the organization's security and compliance standards.
    Data Loss or Misconfiguration:

    In the absence of alerts, critical policy assignments may be deleted, leading to misconfigurations and potential data loss.
    This could impact the integrity of the Azure environment and compromise the confidentiality and availability of resources.
    Regulatory Penalties:

    Non-compliance with security and auditing requirements may result in regulatory penalties, especially in industries with stringent data protection regulations.
    Auditing and monitoring are essential components of compliance, and the lack of an activity log alert may hinder regulatory adherence.
    Operational Disruptions:

    Unmonitored deletions of policy assignments may disrupt operational workflows, leading to downtime or service interruptions.
    This can have cascading effects on other Azure services and impact the overall reliability of the cloud infrastructure.
    Recommendation:
    Implementing an activity log alert for the Delete Policy Assignment event is crucial for maintaining a secure and compliant Azure environment. The organization should prioritize the following steps:

    markdown

    1. **Configure Activity Log Alert:**
       - Utilize Azure Monitoring to set up a specific activity log alert for the Delete Policy Assignment event.

    2. **Define Alert Criteria:**
       - Clearly define the criteria for triggering the alert, such as specifying the target resource group or subscription and setting appropriate alert thresholds.

    3. **Establish Notification Channels:**
       - Configure notification channels to ensure that relevant stakeholders are promptly informed in the event of a Delete Policy Assignment alert.

    4. **Regular Monitoring and Testing:**
       - Regularly monitor and test the alerting system to ensure its effectiveness in detecting and notifying about policy assignment deletions.

    5. **Documentation and Training:**
       - Document the alerting process and provide training to Azure administrators to ensure awareness of the importance of monitoring and alerting for policy assignment deletions.
    By adhering to these recommendations and implementing the necessary controls, the organization can mitigate the risks associated with non-compliance and enhance the overall security and governance of its Azure environment.
  x-kaytu-usefulness-example:
  - "Below is an example of how you can use Azure Resource Manager (ARM) template markup to create an activity log alert for the Delete Policy Assignment event in Azure.\n\njson\n\n{\n  \"$schema\": \"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#\",\n  \"contentVersion\": \"1.0.0.0\",\n  \"resources\": [\n    {\n      \"type\": \"Microsoft.Insights/activityLogAlerts\",\n      \"apiVersion\": \"2017-04-01\",\n      \"name\": \"DeletePolicyAssignmentAlert\",\n      \"location\": \"global\",\n      \"properties\": {\n        \"enabled\": true,\n        \"scopes\": [\"/subscriptions/{subscriptionId}\"],\n        \"condition\": {\n          \"allOf\": [\n            {\n              \"field\": \"category\",\n              \"equals\": \"Policy\"\n            },\n            {\n              \"field\": \"operationName\",\n              \"equals\": \"Microsoft.Authorization/policyAssignments/delete\"\n            }\n          ]\n        },\n        \"actions\": {\n          \"actionGroups\": [\n            {\n              \"actionGroupId\": \"/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Insights/actionGroups/{actionGroupId}\"\n            }\n          ]\n        }\n      }\n    }\n  ]\n}\nIn this example:\n\nReplace {subscriptionId} with your actual subscription ID.\nReplace {resourceGroupName} with the name of the resource group where you want to create the alert.\nReplace {actionGroupId} with the ID of the action group that should be notified when the alert is triggered.\nThis ARM template creates an activity log alert named \"DeletePolicyAssignmentAlert\" that is triggered when a policy assignment is deleted (Microsoft.Authorization/policyAssignments/delete) within the specified subscription. The alert is configured to send notifications to the specified action group."
Title: Ensure that Activity Log Alert exists for Delete Policy Assignment
