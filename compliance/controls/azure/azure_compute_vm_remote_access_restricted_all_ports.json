{
  "ID": "azure_compute_vm_remote_access_restricted_all_ports",
  "Title": "All network ports should be restricted on network security groups associated to your virtual machine",
  "Description": "Azure Security Center has identified some of your network security groups' inbound rules to be too permissive. Inbound rules should not allow access from 'Any' or 'Internet' ranges. This can potentially enable attackers to target your resources.",
  "Query": {
    "Engine": "odysseus-v0.0.1",
    "QueryToExecute": "with network_sg as (\n  select\n    distinct name as sg_name,\n    network_interfaces\n  from\n    azure_network_security_group as nsg,\n    jsonb_array_elements(security_rules) as sg,\n    jsonb_array_elements_text(sg -\u003e 'properties' -\u003e 'destinationPortRanges' || (sg -\u003e 'properties' -\u003e 'destinationPortRange') :: jsonb) as dport,\n    jsonb_array_elements_text(sg -\u003e 'properties' -\u003e 'sourceAddressPrefixes' || (sg -\u003e 'properties' -\u003e 'sourceAddressPrefix') :: jsonb) as sip\n  where\n    sg -\u003e 'properties' -\u003e\u003e 'access' = 'Allow'\n    and sg -\u003e 'properties' -\u003e\u003e 'direction' = 'Inbound'\n    and sg -\u003e 'properties' -\u003e\u003e 'protocol' in ('TCP','*')\n    and sip in ('*', '0.0.0.0', '0.0.0.0/0', 'Internet', '\u003cnw\u003e/0', '/0')\n)\nselect\n  vm.vm_id as resource,\n  case\n    when sg.sg_name is null then 'ok'\n    else 'alarm'\n  end as status,\n  case\n    when sg.sg_name is null then vm.title || ' restricts remote access from internet.'\n    else vm.title || ' allows remote access from internet.'\n  end as reason\n  \n  , vm.resource_group as resource_group\n  , sub.display_name as subscription\nfrom\n  azure_compute_virtual_machine as vm\n  left join network_sg as sg on sg.network_interfaces @\u003e vm.network_interfaces\n  join azure_subscription as sub on sub.subscription_id = vm.subscription_id;\n",
    "Connector": "Azure",
    "PrimaryTable": "azure_compute_virtual_machine",
    "ListOfTables": [
      "azure_compute_virtual_machine",
      "azure_network_security_group",
      "azure_subscription"
    ]
  },
  "ManualVerification": false,
  "Severity": "",
  "Tags": {
    "hipaa_hitrust_v92": [
      "true"
    ],
    "nist_sp_800_53_rev_5": [
      "true"
    ],
    "pci_dss_v321": [
      "true"
    ],
    "service": [
      "Azure/Compute"
    ]
  },
  "Managed": true
}