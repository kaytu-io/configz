Description: Real-time monitoring of API calls can be achieved by directing CloudTrail Logs to CloudWatch Logs and establishing corresponding metric filters and alarms. NACLs are used as a stateless packet filter to control ingress and egress traffic for subnets within a VPC. It is recommended that a metric filter and alarm be established for changes made to NACLs.
DocumentURI: ""
ID: aws_log_metric_filter_network_acl
Managed: true
ManualVerification: false
Query:
  Connector: AWS
  Engine: odysseus-v0.0.1
  ListOfTables:
  - aws_account
  - aws_cloudtrail_trail
  - aws_cloudwatch_alarm
  - aws_cloudwatch_log_metric_filter
  - aws_sns_topic_subscription
  PrimaryTable: aws_account
  QueryToExecute: "with filter_data as (\n  select\n    trail.account_id,\n    trail.name as trail_name,\n    trail.is_logging,\n    split_part(trail.log_group_arn, ':', 7) as log_group_name,\n    filter.name as filter_name,\n    action_arn as topic_arn,\n    alarm.metric_name,\n    subscription.subscription_arn,\n    filter.filter_pattern\n  from\n    aws_cloudtrail_trail as trail,\n    jsonb_array_elements(trail.event_selectors) as se,\n    aws_cloudwatch_log_metric_filter as filter,\n    aws_cloudwatch_alarm as alarm,\n    jsonb_array_elements_text(alarm.alarm_actions) as action_arn,\n    aws_sns_topic_subscription as subscription\n  where\n    trail.is_multi_region_trail is true\n    and trail.is_logging\n    and se ->> 'ReadWriteType' = 'All'\n    and trail.log_group_arn is not null\n    and filter.log_group_name = split_part(trail.log_group_arn, ':', 7)\n    and filter.filter_pattern ~ '\\s*\\$\\.eventName\\s*=\\s*CreateNetworkAcl.+\\$\\.eventName\\s*=\\s*CreateNetworkAclEntry.+\\$\\.eventName\\s*=\\s*DeleteNetworkAcl.+\\$\\.eventName\\s*=\\s*DeleteNetworkAclEntry.+\\$\\.eventName\\s*=\\s*ReplaceNetworkAclEntry.+\\$\\.eventName\\s*=\\s*ReplaceNetworkAclAssociation'\n    and alarm.metric_name = filter.metric_transformation_name\n    and subscription.topic_arn = action_arn\n)\nselect\n  distinct 'arn:' || a.partition || ':::' || a.account_id as resource,\n  a.kaytu_account_id as kaytu_account_id,\n  a.kaytu_resource_id as kaytu_resource_id,\n  case\n    when f.trail_name is null then 'alarm'\n    else 'ok'\n  end as status,\n  case\n    when f.trail_name is null then 'No log metric filter and alarm exist for changes to NACLs.'\n    else filter_name || ' forwards events for changes to NACLs.'\n  end as reason\n  , a.account_id\nfrom\n  aws_account as a\n  left join filter_data as f on a.account_id = f.account_id;\n"
Severity: medium
Tags:
  category:
  - Compliance
  cis:
  - "true"
  cis_item_id:
  - "3.11"
  cis_level:
  - "2"
  cis_section_id:
  - "3"
  cis_type:
  - scored
  cis_version:
  - v1.2.0
  plugin:
  - aws
  service:
  - AWS/CloudWatch
  x-kaytu-explanation:
  - "# AWS Control: Real-Time API Calls Monitoring and NACLs Changes \n\nAWS provides several tools for monitoring and controlling access to its services. Two such tools are CloudTrail Logs and Network Access Control Lists (NACLs). \n\n## CloudTrail Logs to CloudWatch Logs \n\nWith CloudTrail, you can log, continuously monitor, and retain events related to API calls across your AWS infrastructure. CloudTrail provides a history of AWS API calls for your account, including API calls made via the AWS Management Console, AWS SDKs, command line tools, and higher-level AWS services.\n\nYou can configure CloudTrail Logs to direct to CloudWatch Logs, which allows for real-time monitoring of API calls. This can be achieved by setting up corresponding metric filters and alarms in CloudWatch Logs. \n\n```Markdown\nCloudTrail --logs--> CloudWatch Logs\n                     --metric filters & alarms-->\n```\n\nThis setup allows you to be quickly notified of any changes or suspicious activity related to API calls in your AWS infrastructure.\n\n## Network Access Control Lists (NACLs)\n\nNACLs act as a stateless packet filter for controlling ingress (incoming) and egress (outgoing) traffic for subnets within a Virtual Private Cloud (VPC). \n\n```Markdown\nNACLs\n|_ control ingress/egress traffic \n|_ for subnets within a VPC\n```\n\nSimilar to monitoring API calls, it's also recommended that you establish a metric filter and alarm for any changes made to NACLs. This can help ensure the security and integrity of your network's access controls.\n\n```Markdown\nNACLs \n --changes \n   --metric filter & alarm-->\n```\n\nBy monitoring and alerting on changes to NACLs, you can keep a close eye on your network's security and quickly respond to any potential issues. \n\n---\nIn summary, real-time monitoring of API calls and changes to NACLs is an essential part of maintaining a secure and efficient AWS infrastructure. With CloudTrail Logs, CloudWatch Logs, and NACLs, you have powerful tools at your disposal to achieve this."
  x-kaytu-noncompliance-cost:
  - "Non-compliance with the above-mentioned AWS control may lead to several potential risks and associated costs:\n\n1. **Security Risks**: By not monitoring API calls in real-time, there is a lack of visibility into unauthorized access or unusual activities in your AWS environment. If changes to NACLs (Network Access Control Lists) aren't monitored, potential security threats such as unauthorized access or malicious activities might not be detected timely. \n\n2. **Operational Risks**: Unmonitored API calls can lead to throttling issues or service abuse that can disrupt your operations. Without monitoring changes to NACLs, operational issues might occur without notice that results in system unavailability or even data loss.\n\n3. **Regulatory Compliance Risks**: Depending on the nature of your business, you may be subject to certain regulations or standards (e.g., GDPR, HIPAA) that require strict control and audit logging of access to your systems. Not complying with real-time API monitoring and NACL change tracking could result in non-compliance and associated fines.\n\n4. **Increased Troubleshooting Times**: Without real-time monitoring and alarms, it becomes harder to identify, diagnose, and rectify any issues, which can lead to increased downtime and further operational costs.\n\n5. **Financial Risks**: Unauthorized or unexpected API calls could lead to unexpected costs. Similarly, changes to NACLs that are not tracked could lead to increased network costs.\n\nIn summary, non-compliance with this control doesn't only impact the security and reliability of your AWS resources but can also result in increased operational costs and potential regulatory fines."
  x-kaytu-usefulness-example:
  - "**Example Instance**\n\nLet's consider a hypothetical situation where a company, `XYZ Tech`, is using AWS for managing their online operations. They have a strict security protocol due to the nature of their business. They use various API calls to push and pull data between different AWS services. \n\nTheir configuration primarily includes two AWS services: CloudTrail, for auditing their AWS environment, and CloudWatch, for monitoring their system and application logs in real time. They rely on the CloudWatch service to watch their API calls, especially ones that could potentially change security configurations. They want to monitor any changes made to the Network Access Control Lists (NACLs) as it can potentially open their systems to outside threats, if not handled correctly.\n\nTo achieve this, XYZ Tech established corresponding metric filters and alarms in CloudWatch, using CloudTrail logs as the data source. Any change to the NACLs, such as allowing or blocking new IP ranges, or changing the rule orders, is logged by CloudTrail. CloudWatch then uses the defined metric filters to detect these changes in real-time and triggers the configured alarm to notify the concerned teams immediately via an SNS topic.\n\nIf a malicious user attempts to alter the NACLs, the security team and system administrators get an alert within a fraction of a second. This provides real-time security to their cloud-based infrastructure and results in instant mitigation of potential risks. The concerned teams can then investigate the alerts, identify the culprits, and even revert the changes made to retain the original security configurations very quickly.\n\nThis way, by leveraging the AWS CloudTrail and CloudWatch logs, with appropriate metric filters and alarms for changes to their NACLs, XYZ Tech successfully ensures a real-time defense mechanism against any potential security threats.\n"
Title: Ensure a log metric filter and alarm exist for changes to Network Access Control Lists (NACL)
