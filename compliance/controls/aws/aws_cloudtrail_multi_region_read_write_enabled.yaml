Description: AWS CloudTrail is a web service that records AWS API calls for your account and delivers log files to you. The recorded information includes the identity of the API caller, the time of the API call, the source IP address of the API caller, the request parameters, and the response elements returned by the AWS service. CloudTrail provides a history of AWS API calls for an account, including API calls made via the Management Console, SDKs, command line tools, and higher-level AWS services (such as CloudFormation).
DocumentURI: ""
ID: aws_cloudtrail_multi_region_read_write_enabled
Managed: true
ManualVerification: false
Query:
  Connector: AWS
  Engine: odysseus-v0.0.1
  ListOfTables:
  - aws_account
  - aws_cloudtrail_trail
  PrimaryTable: aws_account
  QueryToExecute: |
    with event_selectors_trail_details as (
      select
        distinct account_id
      from
        aws_cloudtrail_trail,
        jsonb_array_elements(event_selectors) as e
      where
        (is_logging and is_multi_region_trail and e ->> 'ReadWriteType' = 'All')
    ),
    advanced_event_selectors_trail_details as (
      select
        distinct account_id
      from
        aws_cloudtrail_trail,
        jsonb_array_elements_text(advanced_event_selectors) as a
      where
      -- when readOnly = true, then it is readOnly, when readOnly = false then it is writeOnly, if advanced_event_selectors is not null then it is both ReadWriteType
        (is_logging and is_multi_region_trail and advanced_event_selectors is not null and (not a like '%readOnly%'))
    )
    select
      a.title as resource,
      a.kaytu_account_id as kaytu_account_id,
      a.kaytu_resource_id as kaytu_resource_id,
      case
        when d.account_id is null and ad.account_id is null then 'alarm'
        else 'ok'
      end as status,
        case
        when d.account_id is null and ad.account_id is null then 'cloudtrail disabled.'
        else 'cloudtrail enabled.'
      end as reason
    
      , a.account_id
    from
      aws_account as a
      left join event_selectors_trail_details as d on d.account_id = a.account_id
      left join advanced_event_selectors_trail_details as ad on ad.account_id = a.account_id;
Severity: high
Tags:
  category:
  - Compliance
  cis:
  - "true"
  cis_item_id:
  - "2.1"
  cis_level:
  - "1"
  cis_section_id:
  - "2"
  cis_type:
  - scored
  cis_version:
  - v1.2.0
  plugin:
  - aws
  service:
  - AWS/CloudTrail
  x-kaytu-explanation:
  - "# AWS CloudTrail\n\nAWS CloudTrail is a web service that enables you to record your AWS API calls and deliver log files to you. This feature allows you to have a history of API calls for your account and it includes API calls made through different sources such as the Management Console, SDKs, command line tools and higher-level AWS services such as CloudFormation.\n\nThe following information are recorded:\n\n- The identity of the API caller\n- The time of the API call\n- The source IP address of the API caller\n- The request parameters\n- The response elements returned by the AWS service\n\nThis feature is essential for security analysis, resource change tracking, and troubleshooting."
  x-kaytu-noncompliance-cost:
  - "Non-compliance to the AWS CloudTrail control can open up an organization to a number of risks and associated costs. \n\n1. **Security Risks**: Without AWS CloudTrail, organizations lose visibility into activity within their AWS environment. This includes not being able to track modifications to resources or identify potentially unauthorized or malicious activity, which could lead to data breaches or loss.\n  \n2. **Regulatory Compliance Penalties**: Many regulatory frameworks like GDPR, HIPAA, and PCI DSS require logging and monitoring of system activity involving sensitive data. Non-compliance with such regulatory controls can lead to heavy fines and legal penalties.\n   \n3. **Audit Failures**: Without proper logging and monitoring as provided by CloudTrail, organizations may fail audits. Audits are often required to win or keep business in certain sectors, and audit failures can result in financial loss, reputation damage, and losing customer trust.\n\n4. **Operational Issues and Debugging Challenges**: CloudTrail logs can be indispensable for debugging application issues and for operational troubleshooting. A lack of detailed CloudTrail logs may increase time and cost for problem resolution. \n\nThus, in a nutshell, not implementing AWS CloudTrail could significantly increase the operational, security, legal and reputational cost for an organization."
  x-kaytu-usefulness-example:
  - |-
    For example, an AWS user might want to track changes made to their IT environment or perform security analyses and compliance audits. 

    With AWS CloudTrail, they can monitor, log, and store all API calls made on their AWS account. The information recorded by CloudTrail can be utilized for auditing and compliance purposes to track changes made to AWS resources and verify that AWS services are being accessed in line with organizational policies. 

    When an anomaly is detected — for instance, an unusual API call or a substantial increase in data traffic — CloudTrail logs can be analyzed to identify the source of the problem and establish further preventative measures against such occurrences. 

    Through these detailed logs, a deeper understanding of the user actions within the AWS environment can be reached, and CloudTrail can therefore play a significant role in ensuring that environments are secure, appropriately provisioned, well-managed, and in compliance with policies.
Title: Ensure CloudTrail is enabled in all regions
